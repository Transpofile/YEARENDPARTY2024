<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THPAL YEAR END CHRISTMAS RAFFLE 2025 - PRIZE PICKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* Define custom colors as CSS variables for easier maintenance */
        :root {
            --color-primary-red: #ef4444;
            --color-dark-gray: #333;
            --wheel-border-size: 12px;
        }

        /* --- Custom Styles for the Wheel Containers and Pointers --- */
        #wheel-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* Ensures a square shape for perfect circle canvas */
            width: min(90vw, 450px);
            height: min(90vw, 450px); 
            margin: 0 auto;
        }

        /* The canvas itself (the rotating element) */
        .roleta-canvas {
            display: block;
            border-radius: 50%;
            border: var(--wheel-border-size) solid var(--color-dark-gray); 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            /* Keep transition for SPIN only (set to 0s for instant reset in JS) */
            transition: transform 0s ease-out; 
            touch-action: none;
        }

        /* The ARROW POINTER */
        .pointer {
            position: absolute;
            top: calc(0px - var(--wheel-border-size)); /* Position above the border */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid var(--color-primary-red); /* Red color */
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }
        
        /* Fullscreen modal styling */
        #fullscreen-roleta {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #fullscreen-canvas {
            width: min(95vh, 95vw);
            height: min(95vh, 95vw);
            border-width: 20px;
        }
        
        /* Pointer in fullscreen mode */
        #fullscreen-roleta .pointer {
            top: -25px; /* Adjust for larger fullscreen border */
        }

        /* Custom scrollbar for lists */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-red-600 mb-6 tracking-tight">THPAL MINOR PRIZE RAFFLE <a href="Major/Major.html" style="color:Blue;"title="Major Prize"">⯈</a></h1>
        
        <div class="flex justify-center mb-6">
            <button id="tab-wheel" onclick="showTab('wheel')" class="px-6 py-2 rounded-l-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150">Roleta</button>
            <button id="tab-results" onclick="showTab('results')" class="px-6 py-2 rounded-r-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150">Database Record</button>
        </div>

        <div id="tab-content-wheel" class="tab-content space-y-6 relative">
            
            <button onclick="toggleSettingsSidebar()" class="absolute top-0 right-0 p-3 bg-gray-200 hover:bg-gray-300 rounded-full text-gray-700 z-10 shadow-md transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            
            <div id="wheel-container" class="relative">
                <div class="pointer"></div>
                <canvas id="roleta-canvas" class="roleta-canvas" width="400" height="400"></canvas>
            </div>
            
            <div class="text-center space-y-4">
                <p id="message-box" class="text-lg font-bold text-gray-700 h-6">Click the wheel to spin and pick a prize!</p>
                <div class="flex flex-wrap justify-center items-center space-x-4">
                    <button onclick="toggleFullscreen(true)" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-lg shadow-lg transition duration-150">
                        Full Screen
                    </button>
                    <p id="countdown-timer" class="text-lg font-bold text-blue-600 hidden"></p>
                    <button id="remove-winner-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-lg shadow-lg transition duration-150 hidden">
                        Remove Prize Now
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-content-results" class="tab-content hidden space-y-4 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Database Record</h2>

            <div class="flex justify-around bg-gray-100 p-3 rounded-lg border border-gray-200 mb-4">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Available Prizes</p>
                    <p id="active-participants-count" class="text-2xl font-extrabold text-blue-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Total Spins</p>
                    <p id="total-spins-count" class="text-2xl font-extrabold text-purple-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Claimed</p>
                    <p id="claimed-prizes-count" class="text-2xl font-extrabold text-green-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Unclaimed</p>
                    <p id="unclaimed-prizes-count" class="text-2xl font-extrabold text-red-600">0</p>
                </div>
            </div>
            
            <div class="mb-4 relative">
                <input type="text" id="history-search-input" onkeyup="filterResults()" 
                       placeholder="Search Employees, Department and Prizes"
                       class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3 pl-10 text-lg">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="exportData()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    Export Data
                </button>
                <button onclick="document.getElementById('import-file').click()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Import Data
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
            </div>
            
            <div class="max-h-96 overflow-y-auto custom-scroll">
                <table id="results-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Winner (Spun By)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prize Won</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Claimed?</th> 
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <button onclick="clearResults()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                Clear Database
            </button>
        </div>

    </div>
    
    <div id="backdrop" onclick="closeSettingsSidebar()" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-30 transition-opacity duration-300"></div>

    <div id="settings-sidebar" class="fixed inset-y-0 right-0 w-80 md:w-96 max-w-full z-40 bg-white shadow-2xl transition-transform duration-300 transform translate-x-full overflow-y-auto p-6 space-y-6">
        <div class="flex justify-between items-center border-b pb-2 mb-4">
             <h2 class="text-2xl font-bold text-gray-800">Raffle Setup</h2>
             <button onclick="closeSettingsSidebar()" class="text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="border-b pb-6">
            <label for="names-input" class="block text-sm font-medium text-gray-700 mb-2">Prize Items (One per line)</label>
            <textarea id="names-input" rows="12" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3" placeholder="55-inch Smart TV&#10;10k Cash Prize&#10;iPhone 15 Pro Max"></textarea>
            <div class="flex flex-wrap justify-start gap-2 mt-3">
                <button onclick="updatePrizes()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Update Roleta Prizes
                </button>
                <button onclick="shufflePrizes()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Shuffle Prizes
                </button>
                <button onclick="clearNames()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Clear All Prizes
                </button>
                <button onclick="exportPrizes()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Export Prize Items
                </button>
                <button onclick="document.getElementById('import-prizes-file').click()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Import Prize Items
                </button>
                <input type="file" id="import-prizes-file" accept=".json" class="hidden" onchange="importPrizesFromSidebar(event)">
                </div>
        </div>

        <div class="border-b pb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Department List for Spinners</h3>
            <p class="text-sm text-gray-500 mb-2">One Department Name per line.</p>
            <textarea id="department-list-input" rows="6" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3" placeholder="Admin&#10;IT&#10;Production&#10;HR"></textarea>
            <div class="mt-3">
                 <button onclick="updateDepartments()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Update Department List
                </button>
            </div>
        </div>
        
        <div class="pt-4 border-t">
            <label for="spin-duration-input" class="block text-sm font-medium text-gray-700 mb-2">Spin Duration (Seconds)</label>
            <input type="number" id="spin-duration-input" min="1" max="10" value="3" onchange="updateSpinDuration(this.value)" 
                   class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3 text-lg font-bold">
           <p class="text-xs text-gray-500 mt-2">The length of time the wheel will spin (1-10 seconds).</p>
        </div>
    </div>

    <div id="fullscreen-roleta" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-95 z-50 flex flex-col justify-center items-center">
        <div class="relative">
             <div class="pointer"></div>
            <canvas id="fullscreen-canvas" class="roleta-canvas" width="800" height="800"></canvas>
        </div>
        <button onclick="toggleFullscreen(false)" class="mt-8 bg-white text-gray-800 font-bold py-3 px-10 rounded-full shadow-xl hover:bg-gray-200 transition duration-150">
            Exit Full Screen
        </button>
    </div>

    <div id="participant-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[65] flex items-center justify-center transition-opacity duration-300 hidden" aria-modal="true" role="dialog">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform transition-all duration-300 scale-100">
            <button onclick="closeParticipantModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h3 class="mt-4 text-2xl font-extrabold text-gray-900">ENTER DETAILS TO SPIN</h3>
            <p class="mt-2 text-md text-gray-600" id="participant-message">This will be recorded in the Database.</p>

            <div class="mt-6 space-y-4 text-left">
                <div>
                    <label for="modal-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="modal-fullname" oninput="clearParticipantMessage()" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50" placeholder="Please Enter FullName Here">
                </div>
                <div>
                    <label for="modal-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="modal-department" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                         <option value="" disabled selected>Select Department</option>
                    </select>
                </div>
            </div>

            <button onclick="startSpinFromModal()" class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-red-600 text-lg font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                Spin the Wheel!
            </button>
        </div>
    </div>
    <div id="winner-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all duration-300 scale-100">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2zM9 9l3 3m0 0l3-3m-3 3v4"></path>
            </svg>
            <h3 class="mt-4 text-3xl font-extrabold text-gray-900">CONGRATULATIONS!</h3>
            <p class="mt-2 text-3xl font-black text-red-600" id="modal-winner-name">WINNER NAME</p>
            <p class="mt-2 text-xl font-semibold text-gray-700">Has won the amazing prize:</p>
            <p class="text-4xl font-extrabold text-blue-600 mt-2" id="modal-prize-name">PRIZE NAME</p>
            <p class="text-xl font-bold text-gray-500 mt-2" id="modal-winner-dept">DEPARTMENT</p>
            
            <p id="modal-countdown-display" class="mt-6 text-lg font-bold text-gray-600 hidden">
                </p>
            <button onclick="closeWinnerModalAndCleanUp(true)" class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-red-600 text-lg font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                Awesome! (Close)
            </button>
        </div>
    </div>
    
    <div id="history-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 mb-4" id="history-modal-title">View Winner Details</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Winner (Spun By)</label>
                    <input type="text" id="history-name-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prize Won</label>
                    <input type="text" id="history-prize-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" id="history-dept-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date Won</label>
                    <input type="text" id="history-date-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prize Claim Status</label>
                    <select id="history-claimed-status" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                         <option value="true">Claimed</option>
                         <option value="false">Unclaimed</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                    Close
                </button>
                <button id="history-edit-save-btn" onclick="saveHistoryEdit()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition hidden">
                    Save Changes
                </button>
            </div>
        </div>
    </div>


    <script type="text/javascript">
        // --- Polyfill for crypto.randomUUID() for maximum compatibility ---
        if (typeof crypto.randomUUID === 'undefined') {
            crypto.randomUUID = () => {
                // Simple, non-standard-compliant UUID for basic use-case compatibility
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };
        }
        // -----------------------------------------------------------------

        // --- Global Variables ---
        const mainCanvas = document.getElementById('roleta-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        const fullscreenCanvas = document.getElementById('fullscreen-canvas');
        const fullscreenCtx = fullscreenCanvas.getContext('2d');
        
        const settingsSidebar = document.getElementById('settings-sidebar');
        const backdrop = document.getElementById('backdrop');


        // CONSTANT: Delay for automatic prize removal
        const REMOVAL_DELAY_SECONDS = 5;

        let isSpinning = false;
        let rotation = 0; 
        let isFullscreen = false;
        let countdownInterval = null;
        let lastWinner = { prize: null, index: -1 };
        let timer = 0; // Countdown timer value
        
        // --- State Management ---
        let state = {
            prizes: [],
            resultsHistory: [], 
            spinDuration: 3, 
            departments: ["Admin", "IT", "HR", "Accounting", "Production", "Sales"] // DEFAULT DEPARTMENT LIST
        };

        let currentResultId = null; // Used for editing/viewing history
        let currentSpinner = { fullname: null, department: null }; // For storing who spun

        // --- IndexedDB Setup (No change) ---
        const DB_NAME = 'RaffleDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'RaffleStore';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveState() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                store.put(state.prizes, 'prizes');
                store.put(state.resultsHistory, 'history');
                store.put({ spinDuration: state.spinDuration }, 'config');
                store.put(state.departments, 'departments'); // SAVE DEPARTMENTS

                await new Promise(resolve => { transaction.oncomplete = resolve; });
                
                updateStatsDisplay();
            } catch (e) {
                console.error("Failed to save state to IDB:", e);
            }
        }

        async function loadState() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);

                const prizesRequest = store.get('prizes');
                const historyRequest = store.get('history');
                const configRequest = store.get('config');
                const departmentsRequest = store.get('departments'); // LOAD DEPARTMENTS

                return new Promise((resolve) => {
                    transaction.oncomplete = () => {
                        // Prizes
                        if (prizesRequest.result && Array.isArray(prizesRequest.result)) {
                            state.prizes = prizesRequest.result.map(p => p.toString().trim()).filter(p => p.length > 0);
                        } else {
                            state.prizes = [];
                        }

                        // History
                        if (historyRequest.result) {
                            state.resultsHistory = historyRequest.result;
                            state.resultsHistory.forEach(r => {
                                if (typeof r.claimed === 'undefined') r.claimed = true; 
                                if (typeof r.removed === 'undefined') r.removed = r.claimed; 
                                if (typeof r.id === 'undefined') r.id = crypto.randomUUID();
                            });
                        }
                        // Config
                        if (configRequest.result) {
                            state.spinDuration = parseInt(configRequest.result.spinDuration) || 3; 
                        }
                        
                        // Departments
                         if (departmentsRequest.result && Array.isArray(departmentsRequest.result)) {
                            state.departments = departmentsRequest.result.map(d => d.toString().trim()).filter(d => d.length > 0);
                        }
                        
                        resolve();
                    };
                    transaction.onerror = (e) => {
                         console.error("Failed to load state from IDB:", e);
                         resolve(); 
                    }
                });

            } catch (e) {
                console.error("Error setting up IDB for load:", e);
            }
        }


        // --- UI and Settings Functions ---

        window.toggleSettingsSidebar = () => {
            if (settingsSidebar.classList.contains('translate-x-full')) {
                openSettingsSidebar();
            } else {
                closeSettingsSidebar();
            }
        };

        window.openSettingsSidebar = () => {
            updateSettingsUI(); 
            settingsSidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('hidden');
            showMessage("Raffle Setup is ready.");
        };

        window.closeSettingsSidebar = () => {
            settingsSidebar.classList.add('translate-x-full');
            backdrop.classList.add('hidden');
            showMessage("Click the wheel to spin and pick a prize!");
        };


        const updateStatsDisplay = () => {
            const claimedCount = state.resultsHistory.filter(r => r.claimed).length;
            const unclaimedCount = state.resultsHistory.filter(r => !r.claimed).length;

            document.getElementById('active-participants-count').textContent = state.prizes.length;
            document.getElementById('total-spins-count').textContent = state.resultsHistory.length;
            document.getElementById('claimed-prizes-count').textContent = claimedCount;
            document.getElementById('unclaimed-prizes-count').textContent = unclaimedCount;
        };

        window.showTab = (tabName) => {
            const tabs = ['wheel', 'results'];
            const buttonMap = {
                'wheel': 'Roleta',
                'results': 'History'
            };
            
            tabs.forEach(tab => {
                document.getElementById(`tab-content-${tab}`).classList.add('hidden');
                
                const tabButton = document.getElementById(`tab-${tab}`);
                tabButton.classList.remove('bg-red-600', 'text-white');
                tabButton.classList.add('bg-gray-200', 'text-gray-700');
            });

            closeSettingsSidebar();

            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            const selectedButton = document.getElementById(`tab-${tabName}`);
            selectedButton.classList.add('bg-red-600', 'text-white');
            selectedButton.classList.remove('bg-gray-200', 'text-gray-700');

            showMessage(`Switching to ${buttonMap[tabName]}...`); 
            
            setTimeout(() => { 
                if (tabName === 'results') {
                    updateStatsDisplay(); 
                    renderResults(); 
                    showMessage("Viewing Winner Record.");
                } else { 
                    showMessage("Click the wheel to spin and pick a prize!");
                }
            }, 300); 
        };

        const updatePrizeListUI = () => {
             document.getElementById('names-input').value = state.prizes.join('\n');
             
             rotation = 0;
             mainCanvas.style.transition = 'none'; 
             fullscreenCanvas.style.transition = 'none';
             mainCanvas.style.transform = 'rotate(0deg)';
             fullscreenCanvas.style.transform = 'rotate(0deg)';
             mainCanvas.style.transition = 'transform 0s ease-out'; 
             fullscreenCanvas.style.transition = 'transform 0s ease-out';

             drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
             drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
             updateStatsDisplay();
        }

        window.updatePrizes = async () => {
            const namesInput = document.getElementById('names-input').value;
            state.prizes = namesInput.split('\n').map(n => n.trim()).filter(n => n.length > 0);
            
            lastWinner = { prize: null, index: -1 }; 

            await saveState();
            updatePrizeListUI(); 
            showMessage(`Prizes updated successfully! ${state.prizes.length} available.`);
        };
        
        window.shufflePrizes = async () => {
            if (state.prizes.length === 0) {
                 showMessage("No prizes to shuffle.");
                 return;
            }
            
            for (let i = state.prizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.prizes[i], state.prizes[j]] = [state.prizes[j], state.prizes[i]];
            }
            
            await saveState();
            updatePrizeListUI();
            showMessage(`Prizes shuffled!`);
        };


        window.clearNames = async () => {
            if (confirm("Are you sure you want to clear ALL prize items?")) { 
                state.prizes = [];
                await saveState();
                updatePrizeListUI();
                showMessage("All prizes cleared.");
            }
        };

        window.clearResults = async () => {
            if (confirm("Are you sure you want to clear the entire Database? please export first before clear the data to make the data safe, Please click the cancel button to cancel the data and if you already exported the data please click okay to clear the data, This cannot be undone.")) {
                state.resultsHistory = [];
                await saveState();
                renderResults();
                showMessage("Winner Database cleared.");
            }
        };
        
        window.updateSpinDuration = async (value) => {
            const duration = parseInt(value, 10);
            if (isNaN(duration) || duration < 1 || duration > 10) {
                alert("Please enter a valid spin duration between 1 and 10 seconds.");
                document.getElementById('spin-duration-input').value = state.spinDuration;
                return;
            }
            state.spinDuration = duration;
            await saveState();
            showMessage(`Spin duration set to ${duration} seconds.`);
        };

        // NEW: Function to update Department List from sidebar
        window.updateDepartments = async () => {
            const deptInput = document.getElementById('department-list-input').value;
            state.departments = deptInput.split('\n').map(d => d.trim()).filter(d => d.length > 0);
            await saveState();
            populateDepartmentDropdown(); // Refresh the modal dropdown
            updateSettingsUI(); // Refresh sidebar input
            showMessage(`Department list updated! ${state.departments.length} departments available.`);
        };

        const updateSettingsUI = () => {
            document.getElementById('names-input').value = state.prizes.join('\n');
            document.getElementById('spin-duration-input').value = state.spinDuration;
            // NEW: Update department list input
            document.getElementById('department-list-input').value = state.departments.join('\n');
        };

        // NEW: Function to populate the dropdown in the modal
        const populateDepartmentDropdown = () => {
            const dropdown = document.getElementById('modal-department');
            // Clear existing options
            dropdown.innerHTML = '<option value="" disabled selected>Select Department</option>';
            
            state.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                dropdown.appendChild(option);
            });
        };

        // --- Drawing and Spin Logic ---

        const COLORS = ["#FF5733", "#33FF57", "#3357FF", "#FF33F5", "#33FFF5", "#FFC300"];

        const drawWheel = (ctx, width, height) => {
            const prizes = state.prizes;
            const numSectors = prizes.length;
            const arc = 2 * Math.PI / numSectors;
            const radius = Math.min(width, height) / 2 - (width === 800 ? 20 : 12); 
            
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(width / 2, height / 2);
            ctx.rotate(rotation);

            if (numSectors === 0) {
                ctx.fillStyle = "#ccc";
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillStyle = "#333";
                ctx.font = "bold 20px Inter";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("Add Prizes in Setup Sidebar!", 0, 0);
            } else {
                for (let i = 0; i < numSectors; i++) {
                    const startAngle = i * arc;
                    const endAngle = (i + 1) * arc;
                    const colorIndex = i % COLORS.length;

                    // Draw Sector
                    ctx.fillStyle = COLORS[colorIndex];
                    ctx.beginPath();
                    ctx.arc(0, 0, radius, startAngle, endAngle);
                    ctx.lineTo(0, 0);
                    ctx.fill();

                    // Draw a subtle sector separator line
                    ctx.lineWidth = width === 800 ? 2 : 1; 
                    ctx.strokeStyle = "#333"; 
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(radius * Math.cos(startAngle), radius * Math.sin(startAngle));
                    ctx.stroke();

                    // Draw Text
                    ctx.save();
                    ctx.rotate(startAngle + arc / 2);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = "#fff";
                    ctx.font = `bold ${width === 800 ? 22 : 14}px Inter`;

                    // Handle long text: wrap or truncate
                    const maxTextWidth = radius * 0.7; 
                    const text = prizes[i];
                    
                    if (ctx.measureText(text).width > maxTextWidth) {
                        let shortenedText = text;
                        while (ctx.measureText(shortenedText + '...').width > maxTextWidth && shortenedText.length > 0) {
                            shortenedText = shortenedText.slice(0, -1);
                        }
                        ctx.fillText(shortenedText + '...', radius * 0.95, 0);
                    } else {
                        ctx.fillText(text, radius * 0.95, 0);
                    }
                    
                    ctx.restore();
                }
            }
            
            ctx.restore();

            // Draw center circle (pin)
            ctx.fillStyle = "#333";
            ctx.beginPath();
            ctx.arc(width / 2, height / 2, width === 800 ? 20 : 10, 0, 2 * Math.PI);
            ctx.fill();
        };

        const showMessage = (msg) => {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = msg;
        };
        
        const setParticipantMessage = (msg, isError = false) => {
             const messageBox = document.getElementById('participant-message');
             messageBox.textContent = msg;
             if(isError) {
                 messageBox.classList.remove('text-gray-600');
                 messageBox.classList.add('text-red-600', 'font-bold');
             } else {
                 messageBox.classList.add('text-gray-600');
                 messageBox.classList.remove('text-red-600', 'font-bold');
             }
        };
        
        window.clearParticipantMessage = () => {
             setParticipantMessage("This will be recorded in the Database, You can see at the Database Record.");
        }


        const showParticipantModal = (isFullscreenSpin) => {
            if (isSpinning || state.prizes.length === 0) {
                if (state.prizes.length === 0) {
                    showMessage("Please add prizes using the Setup sidebar first!");
                }
                return;
            }
            populateDepartmentDropdown(); // Ensure department list is current
            document.getElementById('participant-modal').dataset.isFullscreenSpin = isFullscreenSpin;
            document.getElementById('modal-fullname').value = '';
            document.getElementById('modal-department').value = ''; // Reset dropdown
            clearParticipantMessage(); // Reset modal message
            document.getElementById('participant-modal').classList.remove('hidden');
            document.getElementById('modal-fullname').focus();
        };

        window.closeParticipantModal = () => {
            document.getElementById('participant-modal').classList.add('hidden');
            document.getElementById('modal-fullname').value = '';
            document.getElementById('modal-department').value = '';
            showMessage("Click the wheel to spin and pick a prize!");
        };

        window.startSpinFromModal = () => {
            const fullname = document.getElementById('modal-fullname').value.trim();
            const department = document.getElementById('modal-department').value.trim();
            const isFullscreenSpin = document.getElementById('participant-modal').dataset.isFullscreenSpin === 'true';

            if (!fullname || !department) {
                setParticipantMessage("❗ Please enter your Full Name and select your Department to spin.", true);
                return;
            }

            // --- NEW: DUPLICATE NAME CHECK ---
            const normalizedName = fullname.toLowerCase();
            const isDuplicate = state.resultsHistory.some(r => r.name.toLowerCase() === normalizedName);
            
            if (isDuplicate) {
                 setParticipantMessage(`❗ ${fullname} has already spun and is recorded in the Database.`, true);
                 return;
            }
            // --- END DUPLICATE NAME CHECK ---

            // Store the spinner's details globally
            currentSpinner.fullname = fullname;
            currentSpinner.department = department;

            // Close the modal and start the spin
            document.getElementById('participant-modal').classList.add('hidden');
            spinWheel(isFullscreenSpin);

            // Clear modal inputs for next spin
            document.getElementById('modal-fullname').value = '';
            document.getElementById('modal-department').value = '';
        };

        const spinWheel = (isFullscreenSpin = false) => {
            if (isSpinning || state.prizes.length === 0) return;
            isSpinning = true;

            const numSectors = state.prizes.length;
            const arc = 2 * Math.PI / numSectors;

            // 1. Determine a random winning index
            const targetIndex = Math.floor(Math.random() * numSectors);
            const prizeWon = state.prizes[targetIndex];
            
            lastWinner = { prize: prizeWon, index: targetIndex }; 

            const canvasToSpin = isFullscreenSpin ? fullscreenCanvas : mainCanvas;
            const actualDuration = state.spinDuration * 1000;
            
            // 2. Calculate the required rotation
            const targetAngle = (targetIndex * arc) + (arc / 2);
            const requiredRotation = (3 * Math.PI / 2) - targetAngle; 

            // Ensure a good number of full rotations (5 to 10)
            const fullRotations = (Math.floor(Math.random() * 6) + 5) * 2 * Math.PI;
            const finalRotation = requiredRotation + fullRotations; 

            // 3. Apply spin animation
            canvasToSpin.style.transition = `transform ${actualDuration / 1000}s cubic-bezier(0.25, 0.1, 0.0, 1.0)`;
            canvasToSpin.style.transform = `rotate(${finalRotation}rad)`;

            rotation = finalRotation % (2 * Math.PI);

            showMessage(`Spinning for a prize... Good luck!`);


            setTimeout(() => {
                isSpinning = false;
                
                canvasToSpin.style.transition = 'none';

                let normalizedRotation = finalRotation % (2 * Math.PI);
                if (normalizedRotation < 0) normalizedRotation += 2 * Math.PI; 

                let effectiveAngle = (2 * Math.PI) + (3 * Math.PI / 2) - normalizedRotation;
                effectiveAngle %= (2 * Math.PI); 

                const winningIndex = Math.floor(effectiveAngle / arc); 

                if (prizeWon) {
                    showMessage(`Winner: ${currentSpinner.fullname} won ${prizeWon}!`);
                    launchConfetti();
                    
                    addNewResultToHistory(prizeWon, winningIndex, currentSpinner.fullname, currentSpinner.department);
                    
                    showWinnerModal(prizeWon, currentSpinner.fullname, currentSpinner.department, winningIndex);

                } else {
                    showMessage("Error determining winner.");
                }
            }, actualDuration + 100); 
        };

        // --- Confetti (No change) ---
        function launchConfetti() {
            const count = 200;
            const defaults = { origin: { y: 0.7 } };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
            }

            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45, });
        }

        const startCountdown = () => {
            timer = REMOVAL_DELAY_SECONDS;
            const timerDisplay = document.getElementById('countdown-timer');
            document.getElementById('remove-winner-btn').classList.remove('hidden');
            timerDisplay.classList.remove('hidden');
            timerDisplay.textContent = `Prize auto-removes in ${timer} seconds...`;
            document.getElementById('modal-countdown-display').textContent = timerDisplay.textContent;
            document.getElementById('modal-countdown-display').classList.remove('hidden');

            clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                timer--;
                if (timer > 0) {
                    timerDisplay.textContent = `Prize auto-removes in ${timer} seconds...`;
                    document.getElementById('modal-countdown-display').textContent = timerDisplay.textContent;
                } else {
                    clearInterval(countdownInterval);
                    timerDisplay.textContent = `Prize removed to the Wheel!`;
                    document.getElementById('modal-countdown-display').textContent = timerDisplay.textContent;

                    if (lastWinner.prize && lastWinner.index !== -1) {
                        removeWinnerFromWheel(lastWinner.prize, lastWinner.index, true);
                    }
                }
            }, 1000);
        };

        window.removeWinnerFromWheel = async (prizeName, winningIndex, isAutoRemoval = false) => {
            if (winningIndex >= 0 && winningIndex < state.prizes.length && state.prizes[winningIndex] === prizeName) {
                const removedPrize = state.prizes.splice(winningIndex, 1)[0]; 

                const latestHistoryEntry = state.resultsHistory.find(r => r.prize === removedPrize && !r.removed && r.name === currentSpinner.fullname);

                if (latestHistoryEntry) {
                    latestHistoryEntry.removed = true; 
                    if (!isAutoRemoval) {
                        latestHistoryEntry.claimed = true;
                    } 
                    await saveState();
                    renderResults();
                } else {
                    console.warn("Could not find corresponding Database entry for removal.");
                }

                lastWinner = { prize: null, index: -1 }; 

                updatePrizeListUI();
                showMessage(`Prize "${prizeName}" removed from the wheel.`);
            } else {
                 showMessage(`Prize "${prizeName}" was already removed.`);
            }
        };

        const showWinnerModal = (prizeWon, winnerName, winnerDept, winningIndex) => {
            document.getElementById('modal-winner-name').textContent = winnerName;
            document.getElementById('modal-prize-name').textContent = prizeWon;
            document.getElementById('modal-winner-dept').textContent = `Department: ${winnerDept}`;
            document.getElementById('winner-modal').classList.remove('hidden');

            const removeButton = document.getElementById('remove-winner-btn');
            removeButton.onclick = () => {
                removeWinnerFromWheel(prizeWon, winningIndex, false);
                window.closeWinnerModalAndCleanUp(false);
            };

            startCountdown();
        };

        window.closeWinnerModalAndCleanUp = (forceClaimAndRemove) => {
            document.getElementById('winner-modal').classList.add('hidden');
            document.getElementById('remove-winner-btn').classList.add('hidden');
            document.getElementById('countdown-timer').classList.add('hidden');
            document.getElementById('modal-countdown-display').classList.add('hidden');
            clearInterval(countdownInterval);

            rotation = 0; 
            mainCanvas.style.transition = 'none';
            fullscreenCanvas.style.transition = 'none';
            mainCanvas.style.transform = 'rotate(0deg)';
            fullscreenCanvas.style.transform = 'rotate(0deg)';
            drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
            drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
            mainCanvas.style.transition = 'transform 0s ease-out';
            fullscreenCanvas.style.transition = 'transform 0s ease-out';

            if (forceClaimAndRemove && lastWinner.prize) {
                const latestHistoryEntry = state.resultsHistory.find(r => r.prize === lastWinner.prize && r.name === currentSpinner.fullname);
                
                if (latestHistoryEntry && !latestHistoryEntry.claimed) {
                    latestHistoryEntry.claimed = true;
                    
                    if (lastWinner.index >= 0 && lastWinner.index < state.prizes.length && state.prizes[lastWinner.index] === lastWinner.prize) {
                        latestHistoryEntry.removed = true;
                        state.prizes.splice(lastWinner.index, 1);
                        updatePrizeListUI();
                        showMessage(`Prize "${lastWinner.prize}" claimed and removed.`);
                    } else {
                        saveState();
                        renderResults(); 
                        showMessage(`Prize "${lastWinner.prize}" claimed.`);
                    }
                }
                
                lastWinner = { prize: null, index: -1 };
            }
        };


        // --- HISTORY MANAGEMENT FUNCTIONS ---

        const addNewResultToHistory = async (prizeWon, winningIndex, winnerName, winnerDept) => {
            const date = new Date();
            const dateFormatted = date.toLocaleDateString(undefined, {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            
            let newResult = {
                id: crypto.randomUUID(), 
                name: winnerName, 
                prize: prizeWon, 
                department: winnerDept,
                date: dateFormatted,
                timestamp: date.getTime(),
                removed: false, 
                claimed: false, 
                winningIndex: winningIndex
            };
            state.resultsHistory.unshift(newResult); 
            await saveState();
            renderResults();
        };

        window.toggleClaimed = async (id) => {
            const index = state.resultsHistory.findIndex(r => r.id === id);
            if (index !== -1) {
                const currentResult = state.resultsHistory[index];
                currentResult.claimed = !currentResult.claimed; 
                
                if (currentResult.claimed) {
                    currentResult.removed = true;
                } else { 
                    currentResult.removed = false;
                }
                await saveState();
                renderResults();
                showMessage(`Record for ${currentResult.name} updated.`);
            }
        };

        window.filterResults = () => {
            const searchTerm = document.getElementById('history-search-input').value.toLowerCase().trim();
            renderResults(searchTerm);
        };

        const renderResults = (searchTerm = '') => {
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = ''; 

            const sortedHistory = [...state.resultsHistory].sort((a, b) => b.timestamp - a.timestamp);

            const filteredHistory = sortedHistory.filter(result => {
                if (searchTerm === '') return true;
                const searchString = `${result.name.toLowerCase()} ${result.prize.toLowerCase()} ${result.department.toLowerCase()}`;
                return searchString.includes(searchTerm);
            });

            if (filteredHistory.length === 0) {
                resultsBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">No matching prizes claimed yet.</td></tr>';
                return;
            }

            filteredHistory.forEach((result, index) => {
                const row = resultsBody.insertRow();
                let bgColor = '';
                if (result.removed && result.claimed) {
                    bgColor = 'bg-green-50'; 
                } else if (!result.claimed) {
                    bgColor = 'bg-yellow-100'; 
                } else {
                    bgColor = (index % 2 === 0 ? 'bg-white' : 'bg-gray-50');
                }
                row.className = bgColor;

                let cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900';
                const originalIndex = state.resultsHistory.findIndex(r => r.id === result.id);
                cell.textContent = state.resultsHistory.length - originalIndex;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-bold';
                cell.textContent = result.name;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-700';
                cell.innerHTML = `${result.prize} ${result.removed ? '<span title="Removed from Wheel" class="text-red-500 ml-1">&#10003;</span>' : ''}`;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                cell.textContent = result.department;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                cell.textContent = result.date;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-bold';
                cell.innerHTML = result.claimed ? '<span class="text-green-600">YES</span>' : '<span class="text-red-600">NO</span>';

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium';
                
                const toggleIcon = result.claimed ? `
                    <button onclick="toggleClaimed('${result.id}')" class="text-yellow-600 hover:text-yellow-900 transition p-1 rounded-md hover:bg-yellow-100 group" title="Mark as Unclaimed">
                        <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                ` : `
                    <button onclick="toggleClaimed('${result.id}')" class="text-green-600 hover:text-green-900 transition p-1 rounded-md hover:bg-green-100 group" title="Mark as Claimed">
                        <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>
                `;

                cell.innerHTML = `
                    <div class="space-x-1 flex items-center">
                        <button onclick="viewResultDetails('${result.id}')" class="text-blue-600 hover:text-blue-900 transition p-1 rounded-md hover:bg-blue-100 group" title="View Details">
                            <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                        ${toggleIcon}
                        <button onclick="editResultDetails('${result.id}')" class="text-purple-600 hover:text-purple-900 transition p-1 rounded-md hover:bg-purple-100 group" title="Edit Record">
                             <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.232z"></path></svg>
                        </button>
                        <button onclick="deleteResult('${result.id}')" class="text-red-600 hover:text-red-900 transition p-1 rounded-md hover:bg-red-100 group" title="Delete Record">
                            <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                `;
            });
        };

        // History Modal Functions
        window.viewResultDetails = (id) => {
            currentResultId = id;
            const result = state.resultsHistory.find(r => r.id === id);
            if (!result) return;
            
            document.getElementById('history-modal-title').textContent = "View Winner Details";
            document.getElementById('history-name-input').value = result.name;
            document.getElementById('history-prize-input').value = result.prize;
            document.getElementById('history-dept-input').value = result.department;
            document.getElementById('history-date-input').value = result.date;
            document.getElementById('history-claimed-status').value = result.claimed ? 'true' : 'false';

            document.getElementById('history-name-input').disabled = true;
            document.getElementById('history-prize-input').disabled = true;
            document.getElementById('history-dept-input').disabled = true;
            document.getElementById('history-claimed-status').disabled = true;
            document.getElementById('history-edit-save-btn').classList.add('hidden');

            document.getElementById('history-modal').classList.remove('hidden');
        };

        window.editResultDetails = (id) => {
            currentResultId = id;
            const result = state.resultsHistory.find(r => r.id === id);
            if (!result) return;
            
            document.getElementById('history-modal-title').textContent = "Edit Winner Record";
            document.getElementById('history-name-input').value = result.name;
            document.getElementById('history-prize-input').value = result.prize;
            document.getElementById('history-dept-input').value = result.department;
            document.getElementById('history-date-input').value = result.date;
            document.getElementById('history-claimed-status').value = result.claimed ? 'true' : 'false';

            document.getElementById('history-name-input').disabled = false;
            document.getElementById('history-prize-input').disabled = false;
            document.getElementById('history-dept-input').disabled = false;
            document.getElementById('history-claimed-status').disabled = false;
            document.getElementById('history-edit-save-btn').classList.remove('hidden');

            document.getElementById('history-modal').classList.remove('hidden');
        };

        window.saveHistoryEdit = async () => {
            const id = currentResultId;
            const newName = document.getElementById('history-name-input').value.trim();
            const newPrize = document.getElementById('history-prize-input').value.trim();
            const newDept = document.getElementById('history-dept-input').value.trim();
            const newClaimed = document.getElementById('history-claimed-status').value === 'true';

            if (!newName || !newPrize || !newDept) {
                alert("Name, Prize, and Department cannot be empty.");
                return;
            }

            const index = state.resultsHistory.findIndex(r => r.id === id);
            if (index !== -1) {
                state.resultsHistory[index].name = newName;
                state.resultsHistory[index].prize = newPrize;
                state.resultsHistory[index].department = newDept;
                state.resultsHistory[index].claimed = newClaimed;
                state.resultsHistory[index].removed = newClaimed;
                
                await saveState();
                renderResults();
                closeHistoryModal();
                showMessage(`Record for ${newName} saved successfully.`);
            }
        };

        window.deleteResult = async (id) => {
            if (confirm("Are you sure you want to delete this winner record?")) {
                const index = state.resultsHistory.findIndex(r => r.id === id);
                if (index !== -1) {
                    state.resultsHistory.splice(index, 1);
                    await saveState();
                    renderResults();
                    showMessage("Record deleted.");
                }
            }
        };

        window.closeHistoryModal = () => {
            document.getElementById('history-modal').classList.add('hidden');
            currentResultId = null;
        };

        // --- Export/Import Data ---

        window.exportData = () => {
            const data = {
                prizes: state.prizes,
                resultsHistory: state.resultsHistory,
                config: { spinDuration: state.spinDuration },
                departments: state.departments // EXPORT DEPARTMENTS
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raffle_data_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("All data exported successfully as JSON.");
        };

        window.exportPrizes = () => {
            const data = {
                prizes: state.prizes
            };
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raffle_prizes_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showMessage("Prize list exported successfully as JSON.");
        };

        window.importPrizesFromSidebar = (event) => {
            const file = event.target.files[0];
            if (!file) {
                event.target.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);

                    if (!importedData.prizes || !Array.isArray(importedData.prizes)) {
                        throw new Error("Invalid file structure. Missing or incorrect 'prizes' array.");
                    }

                    state.prizes = importedData.prizes.map(p => p.toString().trim()).filter(p => p.length > 0);

                    await saveState();
                    updateSettingsUI();
                    updatePrizeListUI();
                    showMessage(`Successfully imported ${state.prizes.length} prize items!`);

                } catch (error) {
                    showMessage("Failed to import prize data: " + error.message);
                    console.error("Prize Import Error:", error);
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file);
        };

        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) {
                event.target.value = null;
                return;
            }
            if (!confirm("WARNING: Are you sure you want to import ALL data? This will MERGE new Prizes and Database Record with existing data, but will OVERWRITE the Spin Duration and Department List settings!")) {
                event.target.value = null; 
                return;
            }
            const reader = new FileReader();
            reader.onload = async (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);

                    // --- 1. Basic Structure Validation ---
                    if (!importedData || typeof importedData !== 'object' || !Array.isArray(importedData.prizes) || !Array.isArray(importedData.resultsHistory) || !importedData.config || typeof importedData.config.spinDuration === 'undefined') {
                        throw new Error("Invalid file structure. Missing required fields (prizes, resultsHistory, or config.spinDuration).");
                    }
                    
                    // Allow 'departments' to be missing for backwards compatibility, but treat as an error if the field exists and is invalid
                    if (importedData.departments && !Array.isArray(importedData.departments)) {
                         throw new Error("Invalid file structure. 'departments' field found but is not an array.");
                    }


                    // --- 2. Data Sanitization and Type Coercion ---
                    const newPrizes = importedData.prizes.map(p => p.toString().trim()).filter(p => p.length > 0);

                    const newResultsHistory = importedData.resultsHistory.map(r => {
                        r.id = r.id ? r.id.toString() : crypto.randomUUID(); 
                        r.timestamp = parseInt(r.timestamp) || Date.now();
                        r.claimed = typeof r.claimed === 'boolean' ? r.claimed : (r.claimed === 'true' || r.claimed === true);
                        r.removed = typeof r.removed === 'boolean' ? r.removed : (r.removed === 'true' || r.removed === true || r.claimed);
                        r.name = r.name ? r.name.toString().trim() : 'Unknown Winner';
                        r.prize = r.prize ? r.prize.toString().trim() : 'Unknown Prize';
                        r.department = r.department ? r.department.toString().trim() : 'Unknown Department';
                        r.date = r.date ? r.date.toString().trim() : new Date(r.timestamp).toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                        r.winningIndex = parseInt(r.winningIndex) || -1;
                        return r;
                    });
                    const newSpinDuration = parseInt(importedData.config.spinDuration);
                    
                    const newDepartments = Array.isArray(importedData.departments) 
                                           ? importedData.departments.map(d => d.toString().trim()).filter(d => d.length > 0)
                                           : []; // Default to empty array if missing/invalid (will merge)

                    // --- 3. Apply New State by MERGING ---
                    
                    // Merge Prizes
                    const currentPrizesSet = new Set(state.prizes);
                    const uniqueNewPrizes = newPrizes.filter(p => !currentPrizesSet.has(p));
                    state.prizes = state.prizes.concat(uniqueNewPrizes);

                    // Merge History
                    const existingHistoryIds = new Set(state.resultsHistory.map(r => r.id));
                    const uniqueNewHistory = newResultsHistory.filter(r => !existingHistoryIds.has(r.id));
                    state.resultsHistory = uniqueNewHistory.concat(state.resultsHistory);
                    
                    // Merge Departments: Add new departments, keep existing ones
                    const currentDeptSet = new Set(state.departments);
                    const uniqueNewDepartments = newDepartments.filter(d => !currentDeptSet.has(d));
                    state.departments = state.departments.concat(uniqueNewDepartments);


                    // Overwrite Configuration
                    state.spinDuration = newSpinDuration;

                    await saveState();

                    // Update UI
                    updatePrizeListUI();
                    renderResults();
                    populateDepartmentDropdown(); // Refresh department list after merge

                    // Final message
                    showMessage(`Import successful! Added ${uniqueNewPrizes.length} new prizes, ${uniqueNewHistory.length} new history records, and ${uniqueNewDepartments.length} new departments.`);

                } catch (error) {
                    showMessage("Failed to import data: " + error.message);
                    console.error("Import Error:", error);
                } finally {
                    event.target.value = null; 
                }
            };
            reader.readAsText(file); 
        };
        
        // --- Full Screen Management (No change) ---

        window.toggleFullscreen = (show) => {
            const fsRoleta = document.getElementById('fullscreen-roleta');
            isFullscreen = show;
            
            if (show) {
                fsRoleta.classList.remove('hidden');
                fsRoleta.style.display = 'flex';
                drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
                document.body.style.overflow = 'hidden';
            } else {
                fsRoleta.classList.add('hidden');
                fsRoleta.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadState();
            updateSettingsUI();
            
            drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
            drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);

            renderResults();
            updateStatsDisplay(); 
            populateDepartmentDropdown(); // Initial call to populate the dropdown
            showTab('wheel'); 

            mainCanvas.addEventListener('click', () => showParticipantModal(false));
            fullscreenCanvas.addEventListener('click', () => showParticipantModal(true));
        });

    </script>
<script>
        function protectSourceCode() {
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                    (e.ctrlKey && e.keyCode === 85) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 67) || 
                    (e.ctrlKey && e.keyCode === 83) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74)) {
                    e.preventDefault();
                    return false;
                }
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });

            document.onselectstart = function() {
                return false;
            };

            document.oncontextmenu = function() {
                return false;
            };
        }

        window.addEventListener('load', protectSourceCode);
    </script>


</body>
</html>
