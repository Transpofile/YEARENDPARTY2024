<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THPAL YEAR END PARTY 2025 - Taganito Hpal Nickel Corporation</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.3/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.3/themes/base/jquery-ui.css">

    <script src="https://cdn.tailwindcss.com"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.13/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="source/Yearendscript.css"/>
<style>
      :root {
            --bg-body: #f0fdf4;
            --bg-container: #ffffff;
            --text-primary: #1f2937;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --header-bg: #ffffff;
            --main-border-top: #ef4444;
            --main-border-bottom: #10B981;
            --input-bg: #ffffff;
            --table-header-bg: #f9fafb;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        body.dark-mode {
            --bg-body: #111827;
            --bg-container: #1f2937;
            --text-primary: #f3f4f6;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --header-bg: #1f2937;
            --main-border-top: #ef4444;
            --main-border-bottom: #10B981;
            --input-bg: #374151;
            --table-header-bg: #374151;
            color: var(--text-primary);
            background-color: var(--bg-body);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            background-image: url('https://www.transparenttextures.com/patterns/christmas-x.png');
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .main-christmas-container {
            border-top: 5px solid var(--main-border-top);
            border-bottom: 5px solid var(--main-border-bottom);
            padding-top: 1rem;
            padding-bottom: 1rem;
        }

        .bg-white,
        header,
        .modal-content {
            background-color: var(--bg-container) !important;
            transition: background-color 0.5s ease;
        }

        .text-gray-700,
        .text-gray-800,
        .text-gray-500 {
            color: var(--text-primary) !important;
            transition: color 0.5s ease;
        }

        .border-gray-200,
        .border-gray-300,
        .divide-gray-200 {
            border-color: rgba(75, 85, 99, 0.5) !important;
            transition: border-color 0.5s ease;
        }

        .shadow-md,
        .shadow-lg,
        .shadow {
            box-shadow: var(--shadow);
            transition: box-shadow 0.5s ease;
        }

        .bg-gray-50,
        .fc-theme-standard td,
        .fc-theme-standard th {
            background-color: var(--table-header-bg) !important;
            transition: background-color 0.5s ease;
        }

        .table-container {
            overflow-x: auto;
            width: 100%;

        }
        
        #winner-log-table-wrapper {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
	    
        }

        th,
        td {
            white-space: nowrap;
            font-size: .8rem;
        }

        input:not([type="hidden"]):not([type="file"]),
        textarea,
        select {
            background-color: var(--input-bg) !important;
            color: var(--text-primary) !important;
        }


        .select-container {
            position: relative;
        }

        .select-container::after {
            content: '▼';
            position: absolute;
            top: 50%;
            right: 12px;
            transform: translateY(-50%);
            pointer-events: none;
            color: #4b5563;
            font-size: 10px;
        }

        body.dark-mode .select-container::after {
            color: #d1d5db;
        }


        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 50;
        }

        #liveSpinAccessModal .modal-content {
            height: 100vh;
            max-width: 100vw;
            display: flex;
        }

        .slick-prev:before,
        .slick-next:before {
            color: #1e3a8a !important;
            font-size: 30px !important;
            opacity: 1 !important;
        }

        #calendar .fc-event {
            font-size: 0.75rem;
            padding: 1px 3px;
	    height:10px;
        }

        .fc-toolbar-title {
            font-size: 1rem !important;
        }

        .fc-toolbar-chunk .fc-button {
            font-size: 0.8rem !important;
            padding: 4px 8px !important;
        }

        .fc-toolbar-chunk .fc-prev-button,
        .fc-toolbar-chunk .fc-next-button {
            padding: 4px 6px !important;
        }

        body.dark-mode .fc-col-header-cell,
        body.dark-mode .fc-daygrid-body,
        body.dark-mode .fc-view-harness,
        body.dark-mode .fc-toolbar {
            background-color: var(--bg-container);
            color: var(--text-primary);
        }

        body.dark-mode .fc-button-primary {
            background-color: #3b82f6 !important;
            border-color: #3b82f6 !important;
            color: white !important;
        }

        body.dark-mode .fc-button-primary:hover {
            background-color: #2563eb !important;
        }
        
        #department-counts {
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
            gap: 1rem;
        }
        #department-counts > div {
            min-width: 300px;
            max-width: 350px; 
            width: 100%;
        }

        .modal-tab-button.active {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

	
</style>

    <script type="module">
        const DB_NAME = 'RoletaWinnerDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'winners';
        let db = null;

        let results = [];
        let sortDirection = 'desc';

        const liveSpinPassword = 'THPAL2025';
        const securityPassword = 'THPAL2025';
        const liveWheelIframeUrl = 'https://wheelofnames.com/';
        let securedAction = null;

        let pendingWinnerData = null;

        const majorPrizes = [
            {
                name: 'House and Lot with Swimming Pool and Jacuzzi Pool',
                image: 'https://via.placeholder.com/300x200/F59E0B/FFFFFF?text=Major+Prize+1'
            },
            {
                name: 'Tour anywhere in the world with allowance of 1.5 Billion',
                image: 'https://via.placeholder.com/300x200/10B981/FFFFFF?text=Major+Prize+2'
            },
            {
                name: 'Free Shopping worth of 1 Billion',
                image: 'https://via.placeholder.com/300x200/EF4444/FFFFFF?text=Major+Prize+3'
            }
        ];

        const departments = [
            "HRD (Human Resources)", "Finance", "Operations", "Mining", "Processing Plant",
            "Logistics", "Safety", "Environment", "Community Relations", "Engineering",
            "IT (Information Technology)", "Management", "General Services", "Security"
        ];

        window.calendar = null;

        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = 'p-3 rounded-lg text-sm transition-opacity duration-300';

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
                if (document.body.classList.contains('dark-mode')) {
                    messageBox.classList.remove('bg-green-100');
                    messageBox.classList.add('bg-green-800', 'text-green-100');
                }
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
                if (document.body.classList.contains('dark-mode')) {
                    messageBox.classList.remove('bg-red-100');
                    messageBox.classList.add('bg-red-800', 'text-red-100');
                }
            } else {
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
                if (document.body.classList.contains('dark-mode')) {
                    messageBox.classList.remove('bg-blue-100');
                    messageBox.classList.add('bg-blue-800', 'text-blue-100');
                }
            }

            messageBox.classList.remove('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        function getSessionLogCount() {
            const count = sessionStorage.getItem('sessionLogCount');
            return parseInt(count, 10) || 0;
        }

        function incrementSessionLogCount() {
            const newCount = getSessionLogCount() + 1;
            sessionStorage.setItem('sessionLogCount', newCount);
            return newCount;
        }

        function openDatabase() {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) {
                    reject(new Error("IndexedDB is not supported by this browser."));
                    return;
                }

                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, {
                            keyPath: 'timestamp'
                        });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error on open:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        function getAllWinners() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("Database not initialized."));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = (event) => {
                    const results = event.target.result.map(item => ({
                        ...item,
                        timestamp: new Date(item.timestamp)
                    }));
                    resolve(results);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function addWinner(winnerData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("Database not initialized."));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const dataToStore = {
                    ...winnerData,
                    timestamp: Date.now()
                };
                const request = store.add(dataToStore);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getWinner(timestamp) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("Database not initialized."));
                    return;
                }
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(timestamp);
                request.onsuccess = (event) => {
                    const result = event.target.result;
                    if (result) {
                        result.timestamp = new Date(result.timestamp);
                    }
                    resolve(result);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        }


        window.deleteWinner = async function(timestamp) {
            showConfirmationModal("Delete Record",
                "Are you sure you want to delete this winner record? This action cannot be undone.",
                async () => {
                    try {
                        if (!db) {
                            throw new Error("Database not initialized.");
                        }
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.delete(timestamp);

                        request.onsuccess = async () => {
                            await refreshResults();
                            showMessage("Record deleted successfully.", 'info');
                            hideConfirmationModal();
                        };
                        request.onerror = (event) => {
                            console.error("IndexedDB error on delete:", event.target.error);
                            showMessage("Failed to delete record.", 'error');
                            hideConfirmationModal();
                        };
                    } catch (error) {
                        console.error("Error deleting record:", error);
                        showMessage("Failed to delete record.", 'error');
                        hideConfirmationModal();
                    }
                }
            );
        }

        window.clearDatabase = function() {
            showConfirmationModal("Clear Database",
                "Are you absolutely sure you want to delete ALL winner records? This is permanent.",
                async () => {
                    try {
                        if (!db) {
                            throw new Error("Database not initialized.");
                        }
                        const transaction = db.transaction([STORE_NAME], 'readwrite');
                        const store = transaction.objectStore(STORE_NAME);
                        const request = store.clear();

                        request.onsuccess = async () => {
                            await refreshResults();
                            showMessage("Database cleared successfully!", 'info');
                            sessionStorage.removeItem('sessionLogCount');
                            hideConfirmationModal();
                        };
                        request.onerror = (event) => {
                            console.error("IndexedDB error on clear:", event.target.error);
                            showMessage("Failed to clear database.", 'error');
                            hideConfirmationModal();
                        };
                    } catch (error) {
                        console.error("Error clearing database:", error);
                        showMessage("Failed to clear database.", 'error');
                        hideConfirmationModal();
                    }
                }
            );
        }
        
        // --- NEW SECURED CLEAR DATABASE ACTION ---
        window.securedClearDatabaseAction = function() {
            window.openSecurityAccessModal('clear');
        };

        window.securedClearAction = function() {
            // Re-use the existing clearDatabase logic but without the initial confirmation modal
            try {
                if (!db) {
                    throw new Error("Database not initialized.");
                }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();

                request.onsuccess = async () => {
                    await refreshResults();
                    showMessage("Database cleared successfully!", 'info');
                    sessionStorage.removeItem('sessionLogCount');
                };
                request.onerror = (event) => {
                    console.error("IndexedDB error on clear:", event.target.error);
                    showMessage("Failed to clear database.", 'error');
                };
            } catch (error) {
                console.error("Error clearing database:", error);
                showMessage("Failed to clear database.", 'error');
            }
        };

        function updateWinner(winnerData) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error("Database not initialized."));
                    return;
                }
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);

                const dataToStore = {
                    ...winnerData,
                    timestamp: winnerData.timestamp.getTime()
                };
                const request = store.put(dataToStore);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }

        function getCalendarEvents(winners) {
            const groupedByDate = winners.reduce((acc, winner) => {
                const dateStr = moment(winner.timestamp).format('YYYY-MM-DD');
                if (!acc[dateStr]) {
                    acc[dateStr] = [];
                }
                acc[dateStr].push(winner);
                return acc;
            }, {});

            return Object.keys(groupedByDate).map(dateStr => {
                const count = groupedByDate[dateStr].length;
                const claimedCount = groupedByDate[dateStr].filter(w => w.claimed).length;

                return {
                    title: `${count} Winners (${claimedCount} claimed)`,
                    start: dateStr,
                    allDay: true,
                    extendedProps: {
                        winners: groupedByDate[dateStr],
                        date: dateStr
                    },
                    color: count > 0 ? '#10B981' : '#F59E0B',
                    display: 'block'
                };
            });
        }

        function renderCalendar(events) {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                height: '400px', 
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                views: {
                    dayGridMonth: {
                        buttonText: 'Month'
                    },
                    timeGridWeek: {
                        buttonText: 'Week'
                    },
                    timeGridDay: {
                        buttonText: 'Day'
                    }
                },
                events: events,
                eventContent: function(arg) {
                    if (arg.view.type === 'dayGridMonth') {
                        const count = arg.event.extendedProps.winners.length;
                        return {
                            html: `<div class="p-1 rounded-md text-center bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100 font-bold text-xs">${count} Winners</div>`
                        };
                    } else {
                         return {
                             html: `<div class="fc-event-main-frame">
                                <div class="fc-event-time">${arg.timeText}</div>
                                <div class="fc-event-title-container">
                                    <div class="fc-event-title fc-sticky">${arg.event.title}</div>
                                </div>
                             </div>`
                         };
                    }
                },
                dateClick: function(info) {
                    const dateStr = info.dateStr;
                    const dateEvents = events.find(e => e.start === dateStr);
                    
                    if (dateEvents) {
                         window.showCalendarDetailsModal(dateEvents.extendedProps.date, dateEvents.extendedProps.winners);
                    } else {
                        window.showCalendarDetailsModal(dateStr, []);
                    }
                },
                eventClick: function(info) {
                    if (info.event.extendedProps.date) {
                         window.showCalendarDetailsModal(info.event.extendedProps.date, info.event.extendedProps.winners);
                    }
                }
            });

            calendar.render();
            window.calendar = calendar;
        }

        window.showCalendarDetailsModal = function(dateStr, winners) {
            const dateDisplay = moment(dateStr).format('dddd, MMMM Do YYYY');
            document.getElementById('calendar-modal-title').textContent = `Winner Log for ${dateDisplay}`;
            
            const totalWinnersTabContent = document.getElementById('total-winners-tab');
            const claimedWinnersTabContent = document.getElementById('claimed-winners-tab');
            const unclaimedWinnersTabContent = document.getElementById('unclaimed-winners-tab');

            const renderWinnerList = (list) => {
                if (list.length === 0) {
                    return '<p class="text-gray-500 italic p-4">No winners found for this category on this date.</p>';
                }
                
                const isDarkMode = document.body.classList.contains('dark-mode');
                const textBaseClass = isDarkMode ? 'text-gray-300' : 'text-gray-700';

                return `<ul class="divide-y divide-gray-200 dark:divide-gray-700 max-h-96 overflow-y-auto">
                    ${list.map(winner => {
                        const claimedText = winner.claimed ? 'Claimed' : 'Unclaimed';
                        const claimedColor = winner.claimed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';
                        const time = moment(winner.timestamp).format('HH:mm A');
                        
                        return `<li class="p-3 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer flex justify-between items-center transition duration-150" onclick="window.viewDetails(${winner.timestamp.getTime()})">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-semibold truncate ${textBaseClass}">${winner.name}</p>
                                    <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">${winner.prize}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${winner.department}</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold ${claimedColor}">${claimedText}</span>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${time}</p>
                                </div>
                            </li>`;
                    }).join('')}
                </ul>`;
            };

            const claimedWinners = winners.filter(w => w.claimed);
            const unclaimedWinners = winners.filter(w => !w.claimed);

            totalWinnersTabContent.innerHTML = renderWinnerList(winners);
            claimedWinnersTabContent.innerHTML = renderWinnerList(claimedWinners);
            unclaimedWinnersTabContent.innerHTML = renderWinnerList(unclaimedWinners);

            document.getElementById('total-tab-count').textContent = winners.length;
            document.getElementById('claimed-tab-count').textContent = claimedWinners.length;
            document.getElementById('unclaimed-tab-count').textContent = unclaimedWinners.length;
            
            window.switchCalendarTab('total-winners-tab');
            $('#calendarDetailsModal').removeClass('hidden');
        };
        
        window.switchCalendarTab = function(tabId) {
            document.querySelectorAll('.calendar-tab-content').forEach(el => el.classList.add('hidden'));
            
            document.querySelectorAll('.modal-tab-button').forEach(el => el.classList.remove('active'));
            
            document.getElementById(tabId).classList.remove('hidden');
            
            document.querySelector(`[onclick="switchCalendarTab('${tabId}')"]`).classList.add('active');
        };

        window.closeCalendarDetailsModal = function() {
            $('#calendarDetailsModal').addClass('hidden');
        };

        function renderDepartmentCounts() {
            const majorPrizeNames = majorPrizes.map(p => p.name.toLowerCase());

            const counts = results.reduce((acc, winner) => {
                const dept = winner.department.trim() || 'Unspecified';
                if (!acc[dept]) {
                    acc[dept] = {
                        minor: 0,
                        major: 0
                    };
                }

                const prizeLower = winner.prize.trim().toLowerCase();

                if (majorPrizeNames.includes(prizeLower)) {
                    acc[dept].major += 1;
                } else {
                    acc[dept].minor += 1;
                }
                return acc;
            }, {});

            const container = document.getElementById('department-counts');

            if (!container) return;

            if (Object.keys(counts).length === 0) {
                container.innerHTML = '<p class="text-gray-500 italic">No winners to count yet.</p>';
                return;
            }

            const isDarkMode = document.body.classList.contains('dark-mode');

            const minorBgClass = isDarkMode ? 'bg-indigo-900/50 border-indigo-800' : 'bg-indigo-50 border-indigo-200';
            const minorTextClass = isDarkMode ? 'text-indigo-300' : 'text-indigo-600';
            const minorExtraboldClass = isDarkMode ? 'text-indigo-200' : 'text-indigo-800';

            const majorBgClass = isDarkMode ? 'bg-yellow-900/50 border-yellow-800' : 'bg-yellow-50 border-yellow-200';
            const majorTextClass = isDarkMode ? 'text-yellow-300' : 'text-yellow-600';
            const majorExtraboldClass = isDarkMode ? 'text-yellow-200' : 'text-yellow-800';


            const html = Object.keys(counts).sort().map(dept => {
                const {
                    minor,
                    major
                } = counts[dept];
                return `
                    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 shadow-md transition duration-500 flex-shrink-0">
                        <p class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2 truncate">${dept}</p>

                        <div class="flex space-x-2">
                            <div class="flex-1 p-2 ${minorBgClass} rounded-md border text-center shadow-sm">
                                <p class="text-xs font-medium ${minorTextClass}">Minor Prize Winner</p>
                                <p class="text-xl font-extrabold ${minorExtraboldClass}">${minor}</p>
                            </div>
                            <div class="flex-1 p-2 ${majorBgClass} rounded-md border text-center shadow-sm">
                                <p class="text-xs font-medium ${majorTextClass}">Major Prize Winner</p>
                                <p class="text-xl font-extrabold ${majorExtraboldClass}">${major}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        async function refreshResults() {
            try {
                const fetchedResults = await getAllWinners();
                results = fetchedResults;
                filterTable();

                const events = getCalendarEvents(fetchedResults);
                if (window.calendar) {
                    window.calendar.destroy();
                }
                renderCalendar(events);

                renderDepartmentCounts();

            } catch (error) {
                console.error("Error fetching documents:", error);
                showMessage("Error fetching results from the local database.", 'error');
            }
        }

        window.filterTable = function() {
            const searchInput = document.getElementById('search-log-input');
            const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';

            const filteredResults = results.filter(result => {
                if (!searchTerm) return true;

                const nameMatch = result.name.toLowerCase().includes(searchTerm);
                const prizeMatch = result.prize.toLowerCase().includes(searchTerm);
                const deptMatch = result.department.toLowerCase().includes(searchTerm);

                return nameMatch || prizeMatch || deptMatch;
            });

            renderTable(filteredResults);
        }

        window.viewDetails = async function(timestamp) {
            try {
                const winner = await getWinner(timestamp);
                if (!winner) return showMessage("Record not found.", 'error');

                const claimedText = winner.claimed ? 'Claimed' : 'Unclaimed';
                const claimedColor = winner.claimed ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

                document.getElementById('view-name').textContent = winner.name;
                document.getElementById('view-department').textContent = winner.department;
                document.getElementById('view-prize').textContent = winner.prize;
                document.getElementById('view-remarks').textContent = winner.remarks || 'N/A';
                document.getElementById('view-claimed').textContent = claimedText;
                document.getElementById('view-claimed').className = `font-bold ${claimedColor}`;
                document.getElementById('view-timestamp').textContent = winner.timestamp.toLocaleString();

                window.closeCalendarDetailsModal(); 
                $('#viewModal').removeClass('hidden');

            } catch (error) {
                showMessage("Error viewing details. Check console for error.", 'error');
                console.error("View Details Error:", error);
            }
        }

        window.closeViewModal = function() {
            $('#viewModal').addClass('hidden');
        }

        window.editWinner = async function(timestamp) {
            try {
                const originalWinner = await getWinner(timestamp);
                if (!originalWinner) return showMessage("Record not found.", 'error');

                document.getElementById('edit-record-id').value = timestamp;
                document.getElementById('edit-full-name').value = originalWinner.name;
                document.getElementById('edit-prize-item').value = originalWinner.prize;
                document.getElementById('edit-remarks').value = originalWinner.remarks || '';
                document.getElementById('edit-claim-status').value = originalWinner.claimed.toString();

                populateDepartmentDropdown('edit-department', originalWinner.department);

                window.closeCalendarDetailsModal(); 
                $('#editModal').removeClass('hidden');

            } catch (error) {
                console.error("Error setting up edit modal:", error);
                showMessage("Failed to load record data for editing.", 'error');
            }
        }

        window.saveEdit = async function(event) {
            event.preventDefault();
            const timestamp = parseInt(document.getElementById('edit-record-id').value);

            try {
                const originalWinner = await getWinner(timestamp);
                if (!originalWinner) throw new Error("Original record not found for update.");

                const updatedWinner = {
                    ...originalWinner,
                    name: document.getElementById('edit-full-name').value,
                    department: document.getElementById('edit-department').value,
                    prize: document.getElementById('edit-prize-item').value,
                    remarks: document.getElementById('edit-remarks').value,
                    claimed: document.getElementById('edit-claim-status').value === 'true',
                };

                await updateWinner(updatedWinner);
                await refreshResults();
                window.closeEditModal();
                showMessage(`Record for ${updatedWinner.name} updated successfully!`, 'success');

            } catch (error) {
                console.error("Error saving record edit:", error);
                showMessage("Failed to save changes.", 'error');
            }
        }

        window.closeEditModal = function() {
            $('#editModal').addClass('hidden');
        }

        window.showConfirmationModal = function(title, message, callback) {
            document.getElementById('confirmation-title').textContent = title;
            document.getElementById('confirmation-message').textContent = message;

            const confirmButton = document.getElementById('confirm-action-btn');
            confirmButton.onclick = () => {
                callback();
            };

            $('#confirmationModal').removeClass('hidden');
        }

        window.hideConfirmationModal = function() {
            $('#confirmationModal').addClass('hidden');
        }

        window.openDataManagementModal = function() {
            $('#dataManagementModal').removeClass('hidden');
        }

        window.closeDataManagementModal = function() {
            $('#dataManagementModal').addClass('hidden');
        }

        window.openSecurityAccessModal = function(actionType) {
            if (actionType === 'export') {
                securedAction = window.securedExportAction;
                document.getElementById('security-modal-title').textContent = 'Secure Data Export';
                document.getElementById('security-modal-message').textContent = 'Enter the security password to download the winner log data.';
            } else if (actionType === 'clear') {
                securedAction = window.securedClearAction;
                document.getElementById('security-modal-title').textContent = 'Secure Database Clear';
                document.getElementById('security-modal-message').textContent = 'Enter the security password to permanently delete ALL winner records.';
            } else {
                // Should not happen with new logic, but as a fallback/example
                securedAction = null; 
                document.getElementById('security-modal-title').textContent = 'Secure Action';
                document.getElementById('security-modal-message').textContent = 'Enter the security password to proceed with the action.';
            }
            
            document.getElementById('security-access-password').value = '';
            $('#security-error').addClass('hidden').text('');

            $('#securityAccessModal').removeClass('hidden');
            document.getElementById('security-access-password').focus();
        };

        window.checkSecurityPassword = function() {
            const password = document.getElementById('security-access-password').value.trim();
            const errorElement = $('#security-error');

            if (password === securityPassword) {
                errorElement.addClass('hidden');
                window.closeSecurityAccessModal();
                if (securedAction) {
                    securedAction();
                }
            } else {
                errorElement.removeClass('hidden').text('❌ Incorrect security password.');
            }
        };

        window.closeSecurityAccessModal = function() {
            $('#securityAccessModal').addClass('hidden');
        };

        // window.securedSubmitAction is removed as per request.

        window.submitResult = async function(event) {
            event.preventDefault();

            const fullName = document.getElementById('full-name').value.trim();
            const department = document.getElementById('department-select').value.trim();
            const prizeItem = document.getElementById('prize-item').value.trim();
            const remarks = document.getElementById('remarks').value.trim();
            const claimedStatus = document.getElementById('claim-status').value === 'Claimed';

            if (!fullName || !department || !prizeItem) {
                showMessage("Please fill in all required fields (Name, Dept, Prize).", 'error');
                return;
            }

            // --- DUPLICATE PRIZE CHECK (NEW FUNCTIONALITY) ---
            const isPrizeDuplicated = results.some(winner => 
                winner.prize.trim().toLowerCase() === prizeItem.toLowerCase()
            );

            if (isPrizeDuplicated) {
                showMessage(`Duplicated Item: The prize "${prizeItem}" has already been logged.`, 'error');
                return;
            }
            // --- END DUPLICATE PRIZE CHECK ---


            const winnerData = {
                name: fullName,
                department: department,
                prize: prizeItem,
                remarks: remarks,
                claimed: claimedStatus,
            };

            // Direct submission (security removed as requested)
            try {
                await addWinner(winnerData);

                const sessionCount = incrementSessionLogCount();

                document.getElementById('roleta-form').reset();
                populateDepartmentDropdown('department-select');

                await refreshResults();

                // Pop-up Message Function (as requested)
                showMessage(`Winner logged successfully! ${fullName} won ${prizeItem}.`, 'success');

            } catch (error) {
                console.error("Error writing document:", error);
                showMessage("Failed to save winner data to local database.", 'error');
            }
        }

        window.securedExportAction = async function() {
            try {
                const data = await getAllWinners();

                const exportableData = data.map(item => ({
                    ...item,
                    timestamp: item.timestamp.getTime()
                }));

                const json = JSON.stringify(exportableData, null, 2);
                const blob = new Blob([json], {
                    type: 'application/json'
                });
                const url = URL.createObjectURL(blob);

                const a = document.createElement('a');
                a.href = url;
                a.download =
                    `roleta_winners_${new Date().toISOString().slice(0, 10).replace(/-/g, '')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage("Data exported successfully!", 'success');
            } catch (error) {
                console.error("Export failed:", error);
                showMessage("Failed to export data.", 'error');
            }
        }

        window.exportData = async function() {
            window.openSecurityAccessModal('export');
        }


        function renderTable(dataToRender) {
            const tbody = document.getElementById('results-tbody');
            const list = dataToRender || results;
            const sortedResults = [...list].sort((a, b) => {
                if (sortDirection === 'asc') {
                    return a.timestamp.getTime() - b.timestamp.getTime();
                } else {
                    return b.timestamp.getTime() - a.timestamp.getTime();
                }
            });

            const isDarkMode = document.body.classList.contains('dark-mode');
            const hoverClass = isDarkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-50';
            const textBaseClass = isDarkMode ? 'text-gray-300' : 'text-gray-700';
            const textMutedClass = isDarkMode ? 'text-gray-400' : 'text-gray-500';
            const bgHeaderClass = isDarkMode ? 'bg-gray-800' : 'bg-gray-50';
            const textHeaderClass = isDarkMode ? 'text-gray-400' : 'text-gray-500';

            if (sortedResults.length === 0) {
                const searchInput = document.getElementById('search-log-input');
                const message = searchInput && searchInput.value.trim() !== '' ?
                    `No results found for "${searchInput.value.trim()}".` :
                    'No winners logged yet.';
                tbody.innerHTML =
                    `<tr><td colspan="8" class="py-4 text-center ${textMutedClass}">${message}</td></tr>`;
                return;
            }

            document.querySelector('.table-container thead').classList.remove('bg-gray-50', 'bg-gray-800');
            document.querySelector('.table-container thead').classList.add(bgHeaderClass);
            document.querySelectorAll('.table-container thead th').forEach(th => {
                th.classList.remove('text-gray-500', 'text-gray-400');
                th.classList.add(textHeaderClass);
            });


            tbody.innerHTML = sortedResults.map((result, index) => {
                const recordId = result.timestamp.getTime();
                const dateString = result.timestamp.toLocaleDateString();
                const timeString = result.timestamp.toLocaleTimeString();

                const isClaimed = result.claimed;
                const claimText = isClaimed ? 'Claimed' : 'Unclaimed';
                const claimClasses = isClaimed ? 'bg-green-100 text-green-700 border-green-500 dark:bg-green-800 dark:text-green-100 dark:border-green-600' :
                    'bg-red-100 text-red-700 border-red-500 dark:bg-red-800 dark:text-red-100 dark:border-red-600';

                const prizeCellClass = isDarkMode ? 'font-bold text-teal-300 bg-teal-900/50 border-l-4 border-teal-600' : 'font-bold text-green-700 bg-green-50/70 border-l-4 border-green-500';

                const originalIndex = results.findIndex(r => r.timestamp.getTime() === recordId);
                const displayIndex = originalIndex !== -1 ? originalIndex + 1 : 1;


                return `
                    <tr class="border-b transition duration-150 ${hoverClass}">
                        <td class="px-4 py-2 ${textBaseClass} font-semibold text-sm">${displayIndex}</td>
                        <td class="px-4 py-2 ${textBaseClass}">${result.name}</td>
                        <td class="px-4 py-2 ${textBaseClass}">${result.department}</td>
                        <td class="px-4 py-2 ${prizeCellClass}">${result.prize}</td>
                        <td class="px-4 py-2 ${textBaseClass}">${result.remarks || '-'}</td>
                        <td class="px-4 py-2 text-center">
                            <span class="inline-block px-3 py-1 text-xs font-semibold rounded-full border ${claimClasses}">${claimText}</span>
                        </td>
                        <td class="px-4 py-2 ${textMutedClass} text-sm">${dateString} ${timeString}</td>
                        <td class="px-4 py-2 text-center flex space-x-1 justify-center">
                            <button onclick="viewDetails(${recordId})" title="View Details" class="text-blue-600 hover:text-blue-800 font-medium text-sm transition duration-150 p-1 rounded-md bg-blue-50 dark:bg-blue-900 dark:text-blue-400 dark:hover:text-blue-200">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editWinner(${recordId})" title="Edit Record" class="text-yellow-600 hover:text-yellow-800 font-medium text-sm transition duration-150 p-1 rounded-md bg-yellow-50 dark:bg-yellow-900 dark:text-yellow-400 dark:hover:text-yellow-200">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteWinner(${recordId})" title="Delete Record" class="text-red-600 hover:text-red-800 font-medium text-sm transition duration-150 p-1 rounded-md bg-red-50 dark:bg-red-900 dark:text-red-400 dark:hover:text-red-200">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            const sortIcon = document.getElementById('sort-icon');
            sortIcon.className = sortDirection === 'desc' ? 'fas fa-arrow-down ml-2' : 'fas fa-arrow-up ml-2';
        }

        window.toggleSort = function() {
            sortDirection = sortDirection === 'desc' ? 'asc' : 'desc';
            filterTable();
        }


        window.openLiveSpinModal = function() {
            window.resetLiveSpinModal();
            $('#liveSpinAccessModal').removeClass('hidden');
        };


        window.closeLiveSpinModal = function() {
            document.getElementById('live-spin-wheel-content').innerHTML = '';
            $('#liveSpinAccessModal').addClass('hidden');
        };


        window.openWheelOnly = function() {
            const iframeContent = `
                <iframe id="wheelofname" style="width:100%; height:100%; border:none;" src="${liveWheelIframeUrl}" title="Live Roleta Wheel" allowfullscreen></iframe>
            `;

            document.getElementById('live-spin-wheel-content').innerHTML = iframeContent;


            $('#live-spin-password-section').addClass('hidden');
            $('#live-spin-wheel-section').removeClass('hidden').addClass('flex-1 overflow-auto');
        }

        window.checkLiveSpinPassword = function() {
            const password = document.getElementById('live-spin-access-password').value.trim();
            const errorElement = $('#live-spin-error');

            if (password === liveSpinPassword) {
                errorElement.addClass('hidden');
                window.openWheelOnly();
            } else {
                errorElement.removeClass('hidden').text('❌ Incorrect password. Please try again.');
            }
        };

        window.resetLiveSpinModal = function() {

            document.getElementById('live-spin-wheel-content').innerHTML = '';
            $('#live-spin-wheel-section').removeClass('flex-1 overflow-auto').addClass('hidden');
            $('#live-spin-password-section').removeClass('hidden');
            document.getElementById('live-spin-access-password').value = '';
            $('#live-spin-error').addClass('hidden').text('');
        };


        window.triggerImport = function() {
            document.getElementById('import-file-input').click();
        }

        window.handleImport = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!Array.isArray(importedData)) {
                        throw new Error("Invalid file structure. Expected an array.");
                    }

                    const isValid = importedData.every(item =>
                        item.timestamp && typeof item.timestamp === 'number' &&
                        item.name && item.prize && item.department
                    );

                    if (!isValid) {
                        throw new Error("Data structure invalid. Missing required fields.");
                    }

                    showConfirmationModal("Import Data",
                        `Are you sure you want to import ${importedData.length} records? This will add to the existing database.`,
                        async () => {
                            try {
                                if (!db) throw new Error("Database not initialized.");
                                const transaction = db.transaction([STORE_NAME], 'readwrite');
                                const store = transaction.objectStore(STORE_NAME);

                                for (const item of importedData) {
                                    store.put(item);
                                }

                                await new Promise((res, rej) => {
                                    transaction.oncomplete = () => res();
                                    transaction.onerror = (event) => rej(event.target.error);
                                });

                                await refreshResults();
                                showMessage(`${importedData.length} records imported/merged successfully.`, 'success');
                                hideConfirmationModal();
                            } catch (error) {
                                console.error("Import operation failed:", error);
                                showMessage(`Failed to process import: ${error.message}`, 'error');
                                hideConfirmationModal();
                            }
                        }
                    );

                } catch (error) {
                    console.error("Import reading failed:", error);
                    showMessage(`Error importing file: ${error.message}`, 'error');
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        function populateDepartmentDropdown(elementId, selectedValue = '') {
            const selectElement = document.getElementById(elementId);
            if (!selectElement) return;

            selectElement.innerHTML = '';

            const defaultOption = document.createElement('option');
            defaultOption.value = "";
            defaultOption.textContent = "Select Department";
            defaultOption.disabled = true;
            defaultOption.selected = selectedValue === '';
            selectElement.appendChild(defaultOption);


            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                if (dept === selectedValue) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        window.toggleDarkMode = function() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');

            const icon = document.getElementById('dark-mode-icon');
            icon.className = isDarkMode ? 'fas fa-sun' : 'fas fa-moon';

            renderDepartmentCounts();
            filterTable();

            if (window.calendar) {
                const events = getCalendarEvents(results);
                window.calendar.destroy(); 
                renderCalendar(events);
            }
        };

        $(document).ready(async function() {
            if (localStorage.getItem('darkMode') === 'enabled' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').className = 'fas fa-sun';
            }

            populateDepartmentDropdown('department-select');
            populateDepartmentDropdown('edit-department');

            try {
                await openDatabase();
                await refreshResults();
            } catch (error) {
                console.error("Initialization Failed:", error);
                showMessage("Application failed to initialize database.", 'error');
            }

            const prizeSlider = document.querySelector('.major-prize-slider');
            if (prizeSlider && majorPrizes.length > 0) {
                prizeSlider.innerHTML = majorPrizes.map(prize => `
                    <div class="p-4">
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center transition duration-300 hover:shadow-xl border-t-4 border-blue-600">
                            <h3 class="text-3xl font-extrabold text-blue-700 mb-4">${prize.name}</h3>
                            <div class="flex justify-center items-center mb-4">
                                <img src="${prize.image}" alt="${prize.name}" class="rounded-lg object-cover w-full h-48">
                            </div>
                            <p class="text-gray-500 font-semibold">The Grand Prize awaits its winner!</p>
                        </div>
                    </div>
                `).join('');

                $('.major-prize-slider').slick({
                    dots: false,
                    infinite: true,
                    speed: 500,
                    slidesToShow: 1,
                    autoplay: true,
                    autoplaySpeed: 3000,
                    cssEase: 'linear',
                    arrows: true
                });
            }
        });
    </script>

    <script>
        function protectSourceCode() {
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                    (e.ctrlKey && e.keyCode === 85) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 67) || 
                    (e.ctrlKey && e.keyCode === 83) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74)) {
                    e.preventDefault();
                    return false;
                }
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });

            document.onselectstart = function() {
                return false;
            };

            document.oncontextmenu = function() {
                return false;
            };
        }

        window.addEventListener('load', protectSourceCode);
    </script>

</head>

<body class="bg-gray-50 min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-40 transition duration-500">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-extrabold text-blue-800 dark:text-blue-400 transition duration-500">THPAL YEAR END PARTY 2025</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400 transition duration-500">Taganito Hpal Nickel Corporation</p>
            </div>
            <div class="flex space-x-3 mt-3 sm:mt-0">
                <button onclick="toggleDarkMode()"
                    class="flex items-center bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-500">
                    <i id="dark-mode-icon" class="fas fa-moon"></i>
                </button>

                <button onclick="openDataManagementModal()"
                    class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                    <i class="fas fa-database mr-2"></i> Data Management
                </button>
                <button onclick="openLiveSpinModal()"
                    class="flex items-center bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-200">
                    <i class="fas fa-dice-three mr-2"></i> Live Wheel Spin
                </button>
            </div>
        </div>
    </header>

    <div id="message-box" class="fixed top-20 right-5 opacity-0 transition-opacity duration-300 z-50"></div>

    <main class="max-w-7xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 main-christmas-container">

        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-full transition duration-500">
                <h2 class="text-lg font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 flex items-center transition duration-500">
                    <i class="fas fa-plus-circle mr-2 text-blue-600"></i> Log New Winner
                </h2>

                <form id="roleta-form" onsubmit="submitResult(event)" class="space-y-4">
                    <div>
                        <label for="full-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Winner Full Name <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="full-name" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500 transition duration-500">
                    </div>

                    <div>
                        <label for="department-select" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Department <span
                                class="text-red-500">*</span></label>
                        <div class="select-container">
                            <select id="department-select" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 appearance-none focus:ring-blue-500 focus:border-blue-500 transition duration-500">
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="prize-item" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Prize Category / Item <span
                                class="text-red-500">*</span></label>
                        <input type="text" id="prize-item" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500 transition duration-500"
                            placeholder="Please input Prize Winner Here.!">
                    </div>

                    <div>
                        <label for="claim-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Claim Status</label>
                        <div class="select-container">
                            <select id="claim-status"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 appearance-none focus:ring-blue-500 focus:border-blue-500 transition duration-500">
                                <option value="Unclaimed">Unclaimed</option>
                                <option value="Claimed">Claimed</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label for="remarks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Remarks (Optional)</label>
                        <textarea id="remarks" rows="2"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-blue-500 focus:border-blue-500 transition duration-500"
                            placeholder="Add details about the win or claiming process..."></textarea>
                    </div>

                    <button type="submit" id="submit-btn"
                        class="w-full flex justify-center items-center py-3 px-4 border border-transparent rounded-md shadow-sm text-base font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">
                        <i class="fas fa-arrow-circle-right mr-2"></i> Submit
                    </button>
                </form>

                <hr class="my-6 border-gray-200">

                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 flex items-center transition duration-500">
                    <i class="fas fa-calendar-alt mr-2 text-red-600"></i> Winner Log Calendar
                </h2>
                <div id='calendar'
                    class="p-2 border border-gray-300 rounded-lg shadow-inner bg-gray-50 dark:bg-gray-700 transition duration-500"></div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 transition duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 flex items-center transition duration-500">
                    <i class="fas fa-trophy mr-2 text-yellow-500"></i> Major Prizes Spotlight
                </h2>
                <div class="major-prize-slider">
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 transition duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 flex items-center transition duration-500">
                    <i class="fas fa-chart-bar mr-2 text-indigo-600"></i> Department Prize Winner
                </h2>
                <div id="department-counts">
                    <p class="text-gray-500 italic dark:text-gray-400">Loading statistics...</p>
                </div>
            </div>
            <div
                class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 h-auto min-h-[500px] flex flex-col transition duration-500">
                <h2 class="text-xl font-bold text-gray-700 dark:text-gray-200 mb-4 border-b pb-2 flex items-center transition duration-500">
                    <i class="fas fa-list-alt mr-2 text-green-600"></i> Winner Logs
                </h2>

                <div class="mb-4 flex space-x-3 items-center">
                    <div class="relative flex-1">
                        <input type="text" id="search-log-input" onkeyup="filterTable()"
                            class="block w-full border border-gray-300 rounded-md shadow-sm p-2 pl-10 text-sm focus:ring-blue-500 focus:border-blue-500 transition duration-500"
                            placeholder="Search by Name, Prize, or Department...">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <button onclick="toggleSort()"
                        class="bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-semibold py-2 px-3 rounded-md text-sm transition duration-500">
                        Date <i id="sort-icon" class="fas fa-arrow-down ml-2"></i>
                    </button>
                </div>

                <div id="winner-log-table-wrapper" class="flex-1 table-container">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 transition duration-500">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    #</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Winner Name</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Dept</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Prize</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Remarks</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Log Time</th>
                                <th
                                    class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Actions</th>
                            </tr>
                        </thead>
                        <tbody id="results-tbody" class="bg-white divide-y divide-gray-200">
                            <tr>
                                <td colspan="8" class="py-4 text-center text-gray-500 dark:text-gray-400">Loading
                                    winners...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <div id="calendarDetailsModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300 z-50">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 transition duration-500">
            <div class="p-6">
                <h3 id="calendar-modal-title" class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3 mb-4 transition duration-500">Winner Log for [Date]</h3>
                
                <div class="flex border-b border-gray-200 dark:border-gray-700 mb-4">
                    <button class="modal-tab-button px-4 py-2 text-sm font-medium border-t border-x rounded-t-lg transition duration-150" 
                            onclick="switchCalendarTab('total-winners-tab')">
                        All Winners (<span id="total-tab-count">0</span>)
                    </button>
                    <button class="modal-tab-button px-4 py-2 text-sm font-medium border-t border-x rounded-t-lg transition duration-150" 
                            onclick="switchCalendarTab('claimed-winners-tab')">
                        Claimed (<span id="claimed-tab-count">0</span>)
                    </button>
                    <button class="modal-tab-button px-4 py-2 text-sm font-medium border-t border-x rounded-t-lg transition duration-150" 
                            onclick="switchCalendarTab('unclaimed-winners-tab')">
                        Unclaimed (<span id="unclaimed-tab-count">0</span>)
                    </button>
                </div>

                <div id="total-winners-tab" class="calendar-tab-content"></div>
                <div id="claimed-winners-tab" class="calendar-tab-content hidden"></div>
                <div id="unclaimed-winners-tab" class="calendar-tab-content hidden"></div>

                <div class="mt-6 text-right">
                    <button onclick="closeCalendarDetailsModal()"
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="viewModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transition duration-500">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3 mb-4 transition duration-500">Winner Details</h3>
                <div class="space-y-3">
                    <p class="text-sm"><strong>Name:</strong> <span id="view-name"
                            class="font-semibold text-gray-700 dark:text-gray-300"></span></p>
                    <p class="text-sm"><strong>Department:</strong> <span id="view-department"
                            class="text-gray-600 dark:text-gray-400"></span></p>
                    <p class="text-sm"><strong>Prize:</strong> <span id="view-prize"
                            class="font-bold text-green-700 dark:text-green-400"></span></p>
                    <p class="text-sm"><strong>Remarks:</strong> <span id="view-remarks"
                            class="text-gray-600 dark:text-gray-400"></span>
                    </p>
                    <p class="text-sm"><strong>Status:</strong> <span id="view-claimed" class="font-bold"></span></p>
                    <p class="text-sm"><strong>Log Timestamp:</strong> <span id="view-timestamp"
                            class="text-gray-500 dark:text-gray-400 text-xs"></span></p>
                </div>
                <div class="mt-6 text-right">
                    <button onclick="closeViewModal()"
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300">
        <div class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transition duration-500">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3 mb-4 transition duration-500">Edit Winner Record</h3>
                <form onsubmit="saveEdit(event)" class="space-y-4">
                    <input type="hidden" id="edit-record-id">
                    <div>
                        <label for="edit-full-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Winner Full
                            Name</label>
                        <input type="text" id="edit-full-name" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 transition duration-500">
                    </div>
                    <div>
                        <label for="edit-department" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Department</label>
                        <div class="select-container">
                            <select id="edit-department" required
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 appearance-none focus:ring-yellow-500 focus:border-yellow-500 transition duration-500">
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="edit-prize-item" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Prize Category /
                            Item</label>
                        <input type="text" id="edit-prize-item" required
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 transition duration-500">
                    </div>
                    <div>
                        <label for="edit-claim-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Claim
                            Status</label>
                        <div class="select-container">
                            <select id="edit-claim-status"
                                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 appearance-none focus:ring-yellow-500 focus:border-yellow-500 transition duration-500">
                                <option value="false">Unclaimed</option>
                                <option value="true">Claimed</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="edit-remarks" class="block text-sm font-medium text-gray-700 dark:text-gray-300 transition duration-500">Remarks</label>
                        <textarea id="edit-remarks" rows="2"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-yellow-500 focus:border-yellow-500 transition duration-500"></textarea>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button type="button" onclick="closeEditModal()"
                            class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                            Cancel
                        </button>
                        <button type="submit"
                            class="flex items-center bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                            <i class="fas fa-save mr-2"></i> Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="liveSpinAccessModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300">
        <div class="modal-content bg-white w-full max-w-full flex-col transition duration-500">
            <div
                class="p-4 bg-gray-100 dark:bg-gray-800 border-b flex justify-between items-center shadow-sm transition duration-500">
                <h3 class="text-xl font-bold text-gray-800 dark:text-gray-200 flex items-center transition duration-500">
                    <i class="fas fa-bahai mr-2 text-red-600"></i> Live Roleta Spin Access
                </h3>
                <button onclick="closeLiveSpinModal()"
                    class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition duration-150">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div id="live-spin-password-section" class="p-8 flex flex-col items-center justify-center h-full">
                <h4 class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-300 transition duration-500">Enter Access Password</h4>
                <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 transition duration-500">This protects the live spinning link from accidental access.</p>
                <input type="password" id="live-spin-access-password"
                    onkeypress="if(event.key === 'Enter') checkLiveSpinPassword()"
                    class="w-full max-w-sm border border-gray-300 rounded-lg p-3 text-center text-lg focus:ring-red-500 focus:border-red-500 mb-4 transition duration-500"
                    placeholder="****">
                <button onclick="checkLiveSpinPassword()"
                    class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-200 w-full max-w-sm">
                    Unlock Wheel
                </button>
                <p id="live-spin-error" class="text-red-500 mt-4 hidden"></p>
            </div>

            <div id="live-spin-wheel-section" class="hidden w-full h-full flex-1">
                <div id="live-spin-wheel-content" class="w-full h-full"></div>
            </div>
        </div>
    </div>

    <div id="securityAccessModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300 z-50">
        <div
            class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300">
            <div class="p-6 text-center">
                <i class="fas fa-user-lock text-4xl text-blue-500 mb-4"></i>
                <h3 id="security-modal-title" class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2 transition duration-500">Secure Action</h3>
                <p id="security-modal-message" class="text-sm text-gray-600 dark:text-gray-400 mb-6 transition duration-500">Enter the security password to proceed.</p>

                <input type="password" id="security-access-password"
                    onkeypress="if(event.key === 'Enter') checkSecurityPassword()"
                    class="w-full border border-gray-300 rounded-lg p-3 text-center text-lg focus:ring-blue-500 focus:border-blue-500 mb-4 transition duration-500"
                    placeholder="****">

                <button onclick="checkSecurityPassword()"
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg transition duration-200 w-full mb-4">
                    Authenticate
                </button>
                <p id="security-error" class="text-red-500 mt-2 hidden"></p>
                <button type="button" onclick="closeSecurityAccessModal()"
                    class="w-full bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                    Cancel
                </button>
            </div>
        </div>
    </div>
    <div id="confirmationModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300 z-50">
        <div
            class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all duration-300">
            <div class="p-6 text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                <h3 id="confirmation-title" class="text-xl font-bold text-gray-800 dark:text-gray-200 mb-2 transition duration-500">Confirmation</h3>
                <p id="confirmation-message" class="text-sm text-gray-600 dark:text-gray-400 mb-6 transition duration-500">Are you sure?</p>
                <div class="flex justify-center space-x-4">
                    <button type="button" onclick="hideConfirmationModal()"
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Cancel
                    </button>
                    <button type="button" id="confirm-action-btn"
                        class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg shadow transition duration-150">
                        Confirm
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="dataManagementModal"
        class="hidden fixed inset-0 modal-backdrop flex justify-center items-center transition-opacity duration-300 z-50">
        <div
            class="modal-content bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 transform transition-all duration-300">
            <div class="p-6">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-gray-200 border-b pb-3 mb-4 flex items-center transition duration-500">
                    <i class="fas fa-wrench mr-2 text-indigo-600"></i> Data Management Tools
                </h3>

                <div class="space-y-4">
                    <button onclick="exportData(); closeDataManagementModal()"
                        class="w-full flex items-center justify-center py-3 px-4 rounded-lg bg-green-500 hover:bg-green-600 text-white font-bold transition duration-150 shadow">
                        <i class="fas fa-download mr-2"></i> Export </button>

                    <button onclick="triggerImport()"
                        class="w-full flex items-center justify-center py-3 px-4 rounded-lg bg-blue-500 hover:bg-blue-600 text-white font-bold transition duration-150 shadow">
                        <i class="fas fa-upload mr-2"></i> Import </button>
                    <input type="file" id="import-file-input" accept=".json" onchange="handleImport(event)"
                        class="hidden">

                    <button onclick="securedClearDatabaseAction(); closeDataManagementModal()"
                        class="w-full flex items-center justify-center py-3 px-4 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold transition duration-150 shadow">
                        <i class="fas fa-trash-alt mr-2"></i> Clear All Winner Logs
                    </button>
                </div>

                <div class="mt-6 text-right">
                    <button onclick="closeDataManagementModal()"
                        class="bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg transition duration-150">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
