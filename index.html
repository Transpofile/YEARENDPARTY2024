<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>THPAL YEAR END CHRISTMAS RAFFLE 2025 - PRIZE PICKER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }

        /* Define custom colors as CSS variables for easier maintenance */
        :root {
            --color-primary-red: #ef4444;
            --color-dark-gray: #333;
            --wheel-border-size: 12px;
        }

        /* --- Custom Styles for the Wheel Containers and Pointers --- */
        #wheel-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* Ensures a square shape for perfect circle canvas */
            width: min(90vw, 450px);
            height: min(90vw, 450px); 
            margin: 0 auto;
        }

        /* The canvas itself (the rotating element) */
        .roleta-canvas {
            display: block;
            border-radius: 50%;
            border: var(--wheel-border-size) solid var(--color-dark-gray); 
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            /* Keep transition for SPIN only (set to 0s for instant reset in JS) */
            transition: transform 0s ease-out; 
            touch-action: none;
        }

        /* The ARROW POINTER */
        .pointer {
            position: absolute;
            top: calc(0px - var(--wheel-border-size)); /* Position above the border */
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 30px solid var(--color-primary-red); /* Red color */
            z-index: 10;
            filter: drop-shadow(0 0 5px rgba(0, 0, 0, 0.5));
        }
        
        /* Fullscreen modal styling */
        #fullscreen-roleta {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.95);
            z-index: 50;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #fullscreen-canvas {
            width: min(95vh, 95vw);
            height: min(95vh, 95vw);
            border-width: 20px;
        }
        
        /* Pointer in fullscreen mode */
        #fullscreen-roleta .pointer {
            top: -25px; /* Adjust for larger fullscreen border */
        }

        /* Custom scrollbar for lists */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 3px;
        }
        
        /* CSS for PDF print optimization */
        @media print {
            /* Hide everything except the content container and the results tab */
            body > *:not(#tab-content-results):not(.max-w-6xl):not(style) { display: none !important; }
            .max-w-6xl { width: 100% !important; max-width: none !important; margin: 0 !important; }
            .tab-content { display: block !important; }
            .flex.justify-end.space-x-3 { display: none !important; } 
            .max-h-96.overflow-y-auto.custom-scroll { max-height: none !important; overflow: visible !important; }
            #results-table th, #results-table td { padding: 8px !important; }
            @page { size: A4 landscape; margin: 10mm; }
        }

    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-extrabold text-center text-red-600 mb-6 tracking-tight">THPAL MINOR PRIZE RAFFLE <a href="Major/Major.html" style="color:Blue;"title="Major Prize"">â¯ˆ</a></h1>
        
        <div class="flex justify-center mb-6">
            <button id="tab-wheel" onclick="showTab('wheel')" class="px-6 py-2 rounded-l-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition duration-150">Roleta</button>
            <button id="tab-results" onclick="showTab('results')" class="px-6 py-2 rounded-r-lg font-semibold text-gray-700 bg-gray-200 hover:bg-gray-300 transition duration-150">Database Record</button>
        </div>

        <div id="tab-content-wheel" class="tab-content space-y-6 relative">
            
            <button onclick="toggleSettingsSidebar()" class="absolute top-0 right-0 p-3 bg-gray-200 hover:bg-gray-300 rounded-full text-gray-700 z-10 shadow-md transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
            
            <div id="wheel-container" class="relative">
                <div class="pointer"></div>
                <canvas id="roleta-canvas" class="roleta-canvas" width="400" height="400"></canvas>
            </div>
            
            <div class="text-center space-y-4">
                <p id="message-box" class="text-lg font-bold text-gray-700 h-6">Click the wheel to spin and pick a prize!</p>
                <div class="flex flex-wrap justify-center items-center space-x-4">
                    <p id="countdown-timer" class="text-lg font-bold text-blue-600 hidden"></p>
                    <button id="remove-winner-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-6 rounded-lg shadow-lg transition duration-150 hidden">
                        Remove Prize Now
                    </button>
                </div>
            </div>
        </div>

        <div id="tab-content-results" class="tab-content hidden space-y-4 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Database Record</h2>

            <div class="flex justify-around bg-gray-100 p-3 rounded-lg border border-gray-200 mb-4">
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Available Prizes</p>
                    <p id="active-participants-count" class="text-2xl font-extrabold text-blue-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Total Spins</p>
                    <p id="total-spins-count" class="text-2xl font-extrabold text-purple-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Claimed</p>
                    <p id="claimed-prizes-count" class="text-2xl font-extrabold text-green-600">0</p>
                </div>
                <div class="text-center">
                    <p class="text-xs font-medium text-gray-500">Unclaimed</p>
                    <p id="unclaimed-prizes-count" class="text-2xl font-extrabold text-red-600">0</p>
                </div>
            </div>
            
            <div class="mb-4 relative">
                <input type="text" id="history-search-input" onkeyup="filterResults()" 
                       placeholder="Search Employees, Department and Prizes"
                       class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3 pl-10 text-lg">
                <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            
            <div class="flex justify-end space-x-3 relative">
                 <div id="export-dropdown-container" class="relative">
                    <button onclick="toggleExportDropdown(this)" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center" id="export-menu-button" aria-expanded="false" aria-haspopup="true">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export Data
                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                    </button>

                    <div id="export-menu" class="hidden origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-20" role="menu" aria-orientation="vertical" aria-labelledby="export-menu-button" tabindex="-1">
                        <div class="py-1" role="none">
                            <a href="#" onclick="exportAsJson()" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Export as JSON</a>
                            <a href="#" onclick="exportAsExcel()" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Export as Excel (CSV)</a>
                            <a href="#" onclick="exportAsPdf()" class="text-gray-700 block px-4 py-2 text-sm hover:bg-gray-100" role="menuitem" tabindex="-1">Export as PDF (Print)</a>
                        </div>
                    </div>
                </div>
                
                <button onclick="document.getElementById('import-file').click()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Import Data
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden" onchange="importData(event)">
            </div>
            
            <div class="max-h-96 overflow-y-auto custom-scroll">
                <table id="results-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Winner (Spun By)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prize Won</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Claimed?</th> 
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="results-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <button onclick="clearResults()" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150">
                Clear Database
            </button>
        </div>

    </div>
    
    <div id="backdrop" onclick="closeSettingsSidebar()" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-30 transition-opacity duration-300"></div>

    <div id="settings-sidebar" class="fixed inset-y-0 right-0 w-80 md:w-96 max-w-full z-40 bg-white shadow-2xl transition-transform duration-300 transform translate-x-full overflow-y-auto p-6 space-y-6">
        <div class="flex justify-between items-center border-b pb-2 mb-4">
             <h2 class="text-2xl font-bold text-gray-800">Raffle Setup</h2>
             <button onclick="closeSettingsSidebar()" class="text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="border-b pb-6">
            <label for="names-input" class="block text-sm font-medium text-gray-700 mb-2">Prize Items (One per line)</label>
            <textarea id="names-input" rows="12" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3" placeholder="55-inch Smart TV&#10;10k Cash Prize&#10;iPhone 15 Pro Max"></textarea>
            <div class="flex flex-wrap justify-start gap-2 mt-3">
                <button onclick="updatePrizes()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Update Roleta Prizes
                </button>
                <button onclick="shufflePrizes()" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Shuffle Prizes
                </button>
                <button onclick="clearNames()" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Clear All Prizes
                </button>
                <button onclick="exportPrizes()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Export Prize Items
                </button>
                <button onclick="document.getElementById('import-prizes-file').click()" class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Import Prize Items
                </button>
                <input type="file" id="import-prizes-file" accept=".json" class="hidden" onchange="importPrizesFromSidebar(event)">
                </div>
        </div>

        <div class="border-b pb-6">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Department List for Spinners</h3>
            <p class="text-sm text-gray-500 mb-2">One Department Name per line.</p>
            <textarea id="department-list-input" rows="6" class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3" placeholder="Admin&#10;IT&#10;Production&#10;HR"></textarea>
            <div class="mt-3">
                 <button onclick="updateDepartments()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 text-sm">
                    Update Department List
                </button>
            </div>
        </div>
        
        <div class="pt-4 border-t">
            <label for="spin-duration-input" class="block text-sm font-medium text-gray-700 mb-2">Spin Duration (Seconds)</label>
            <input type="number" id="spin-duration-input" min="1" max="10" value="3" onchange="updateSpinDuration(this.value)" 
                   class="w-full border-gray-300 rounded-lg shadow-sm focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50 p-3 text-lg font-bold">
           <p class="text-xs text-gray-500 mt-2">The length of time the wheel will spin (1-10 seconds).</p>
        </div>
    </div>

    <div id="fullscreen-roleta" class="hidden fixed top-0 left-0 w-full h-full bg-black bg-opacity-95 z-50 flex flex-col justify-center items-center">
        <div class="relative">
             <div class="pointer"></div>
            <canvas id="fullscreen-canvas" class="roleta-canvas" width="800" height="800"></canvas>
        </div>
        <button onclick="toggleFullscreen(false)" 
                class="absolute top-6 right-6 p-4 bg-white hover:bg-gray-200 text-gray-800 rounded-full shadow-xl transition duration-150 z-50"
                title="Exit Full Screen">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <div id="participant-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[65] flex items-center justify-center transition-opacity duration-300 hidden" aria-modal="true" role="dialog">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center transform transition-all duration-300 scale-100">
            <button onclick="closeParticipantModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <h3 class="mt-4 text-2xl font-extrabold text-gray-900">ENTER DETAILS TO SPIN</h3>
            <p class="mt-2 text-md text-gray-600" id="participant-message">This will be recorded in the Database.</p>

            <div class="mt-6 space-y-4 text-left">
                <div>
                    <label for="modal-fullname" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="modal-fullname" oninput="clearParticipantMessage()" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50" placeholder="Please Enter FullName Here">
                </div>
                <div>
                    <label for="modal-department" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="modal-department" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-3 focus:border-red-500 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                         <option value="" disabled selected>Select Department</option>
                    </select>
                </div>
            </div>

            <button onclick="startSpinFromModal()" class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-red-600 text-lg font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                Spin the Wheel!
            </button>
        </div>
    </div>
    <div id="winner-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center transition-opacity duration-300" aria-modal="true" role="dialog">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-lg w-full text-center transform transition-all duration-300 scale-100">
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2zM9 9l3 3m0 0l3-3m-3 3v4"></path>
            </svg>
            <h3 class="mt-4 text-3xl font-extrabold text-gray-900">CONGRATULATIONS!</h3>
            <p class="mt-2 text-3xl font-black text-red-600" id="modal-winner-name">WINNER NAME</p>
            <p class="mt-2 text-xl font-semibold text-gray-700">Has won the amazing prize:</p>
            <p class="text-4xl font-extrabold text-blue-600 mt-2" id="modal-prize-name">PRIZE NAME</p>
            <p class="text-xl font-bold text-gray-500 mt-2" id="modal-winner-dept">DEPARTMENT</p>
            
            <p id="modal-countdown-display" class="mt-6 text-lg font-bold text-gray-600 hidden">
                </p>
            <button onclick="closeWinnerModalAndCleanUp(true)" class="mt-6 w-full inline-flex justify-center rounded-lg border border-transparent shadow-sm px-6 py-3 bg-red-600 text-lg font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">
                Awesome! (Close)
            </button>
        </div>
    </div>
    
    <div id="history-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[70] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-md w-full">
            <h3 class="text-2xl font-extrabold text-gray-900 border-b pb-2 mb-4" id="history-modal-title">View Winner Details</h3>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Winner (Spun By)</label>
                    <input type="text" id="history-name-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prize Won</label>
                    <input type="text" id="history-prize-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Department</label>
                    <input type="text" id="history-dept-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Date Won</label>
                    <input type="text" id="history-date-input" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Prize Claim Status</label>
                    <select id="history-claimed-status" class="mt-1 block w-full border-gray-300 rounded-lg p-2" disabled>
                         <option value="true">Claimed</option>
                         <option value="false">Unclaimed</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button onclick="closeHistoryModal()" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition">
                    Close
                </button>
                <button id="history-edit-save-btn" onclick="saveHistoryEdit()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition hidden">
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <button id="fullscreen-button" onclick="toggleFullscreen(true)" 
        class="fixed bottom-6 right-6 p-4 bg-red-600 hover:bg-red-700 text-white rounded-full shadow-xl transition duration-150 z-40" 
        title="Full Screen Mode">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 4h-4m4 0l-5-5"></path>
        </svg>
    </button>


    <script type="text/javascript">
        // --- Polyfill for crypto.randomUUID() for maximum compatibility ---
        if (typeof crypto.randomUUID === 'undefined') {
            crypto.randomUUID = () => {
                // Simple, non-standard-compliant UUID for basic use-case compatibility
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };
        }
        // -----------------------------------------------------------------

        // --- Global Variables ---
        const mainCanvas = document.getElementById('roleta-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        const fullscreenCanvas = document.getElementById('fullscreen-canvas');
        const fullscreenCtx = fullscreenCanvas.getContext('2d');
        
        const settingsSidebar = document.getElementById('settings-sidebar');
        const backdrop = document.getElementById('backdrop');


        // CONSTANT: Delay for automatic prize removal
        const REMOVAL_DELAY_SECONDS = 5;

        let isSpinning = false;
        let rotation = 0; 
        let isFullscreen = false;
        let countdownInterval = null;
        let lastWinner = { prize: null, index: -1 };
        let timer = 0; // Countdown timer value
        
        // --- State Management ---
        let state = {
            prizes: [],
            resultsHistory: [], 
            spinDuration: 3, 
            departments: ["Admin", "IT", "HR", "Accounting", "Production", "Sales"] // DEFAULT DEPARTMENT LIST
        };

        let currentResultId = null; // Used for editing/viewing history
        let currentSpinner = { fullname: null, department: null }; // For storing who spun

        // --- IndexedDB Setup (No change) ---
        const DB_NAME = 'RaffleDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'RaffleStore';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME);
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB error:", event.target.error);
                    reject(event.target.error);
                };
            });
        }

        async function saveState() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                store.put(state.prizes, 'prizes');
                store.put(state.resultsHistory, 'history');
                store.put({ spinDuration: state.spinDuration }, 'config');
                store.put(state.departments, 'departments'); // SAVE DEPARTMENTS

                await new Promise(resolve => { transaction.oncomplete = resolve; });
                
                updateStatsDisplay();
            } catch (e) {
                console.error("Failed to save state to IDB:", e);
            }
        }

        async function loadState() {
            try {
                const db = await openDB();
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);

                const prizesRequest = store.get('prizes');
                const historyRequest = store.get('history');
                const configRequest = store.get('config');
                const departmentsRequest = store.get('departments'); // LOAD DEPARTMENTS

                return new Promise((resolve) => {
                    transaction.oncomplete = () => {
                        // Prizes
                        if (prizesRequest.result && Array.isArray(prizesRequest.result)) {
                            state.prizes = prizesRequest.result.map(p => p.toString().trim()).filter(p => p.length > 0);
                        } else {
                            state.prizes = [];
                        }

                        // History
                        if (historyRequest.result) {
                            state.resultsHistory = historyRequest.result;
                            state.resultsHistory.forEach(r => {
                                if (typeof r.claimed === 'undefined') r.claimed = true; 
                                if (typeof r.removed === 'undefined') r.removed = r.claimed; 
                                if (typeof r.id === 'undefined') r.id = crypto.randomUUID();
                            });
                        }
                        // Config
                        if (configRequest.result) {
                            state.spinDuration = parseInt(configRequest.result.spinDuration) || 3; 
                        }
                        
                        // Departments
                         if (departmentsRequest.result && Array.isArray(departmentsRequest.result)) {
                            state.departments = departmentsRequest.result.map(d => d.toString().trim()).filter(d => d.length > 0);
                        }
                        
                        resolve();
                    };
                    transaction.onerror = (e) => {
                         console.error("Failed to load state from IDB:", e);
                         resolve(); 
                    }
                });

            } catch (e) {
                console.error("Error setting up IDB for load:", e);
            }
        }


        // --- UI and Settings Functions ---

        window.toggleSettingsSidebar = () => {
            if (settingsSidebar.classList.contains('translate-x-full')) {
                openSettingsSidebar();
            } else {
                closeSettingsSidebar();
            }
        };

        window.openSettingsSidebar = () => {
            updateSettingsUI(); 
            settingsSidebar.classList.remove('translate-x-full');
            backdrop.classList.remove('hidden');
            showMessage("Raffle Setup is ready.");
        };

        window.closeSettingsSidebar = () => {
            settingsSidebar.classList.add('translate-x-full');
            backdrop.classList.add('hidden');
            showMessage("Click the wheel to spin and pick a prize!");
        };


        const updateStatsDisplay = () => {
            const claimedCount = state.resultsHistory.filter(r => r.claimed).length;
            const unclaimedCount = state.resultsHistory.filter(r => !r.claimed).length;

            document.getElementById('active-participants-count').textContent = state.prizes.length;
            document.getElementById('total-spins-count').textContent = state.resultsHistory.length;
            document.getElementById('claimed-prizes-count').textContent = claimedCount;
            document.getElementById('unclaimed-prizes-count').textContent = unclaimedCount;
        };

        window.showTab = (tabName) => {
            const tabs = ['wheel', 'results'];
            const buttonMap = {
                'wheel': 'Roleta',
                'results': 'Database Record'
            };
            
            tabs.forEach(tab => {
                document.getElementById(`tab-content-${tab}`).classList.add('hidden');
                
                const tabButton = document.getElementById(`tab-${tab}`);
                tabButton.classList.remove('bg-red-600', 'hover:bg-red-700', 'text-white');
                tabButton.classList.add('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');
            });
            
            document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
            const activeTabButton = document.getElementById(`tab-${tabName}`);
            activeTabButton.classList.add('bg-red-600', 'hover:bg-red-700', 'text-white');
            activeTabButton.classList.remove('bg-gray-200', 'hover:bg-gray-300', 'text-gray-700');

            if (tabName === 'results') {
                renderResults(); // Refresh history when switching to results tab
                closeSettingsSidebar(); // Ensure sidebar is closed when viewing results
            }
        };

        window.showMessage = (message, isError = false) => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            if (isError) {
                msgBox.classList.remove('text-gray-700', 'text-blue-600', 'text-green-600');
                msgBox.classList.add('text-red-600');
            } else {
                msgBox.classList.remove('text-red-600');
                msgBox.classList.add('text-gray-700'); 
            }
        };

        const updateSettingsUI = () => {
            document.getElementById('names-input').value = state.prizes.join('\n');
            document.getElementById('spin-duration-input').value = state.spinDuration;
            document.getElementById('department-list-input').value = state.departments.join('\n');
            updatePrizeListUI();
        };

        const updatePrizeListUI = () => {
            rotation = 0;
            mainCanvas.style.transition = 'none';
            fullscreenCanvas.style.transition = 'none';
            mainCanvas.style.transform = 'rotate(0deg)';
            fullscreenCanvas.style.transform = 'rotate(0deg)';
            mainCanvas.style.transition = 'transform 0s ease-out';
            fullscreenCanvas.style.transition = 'transform 0s ease-out';
            drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
            drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
            updateStatsDisplay();
        };

        window.updatePrizes = async () => {
            const namesInput = document.getElementById('names-input').value;
            state.prizes = namesInput.split('\n').map(n => n.trim()).filter(n => n.length > 0);
            lastWinner = { prize: null, index: -1 };
            await saveState();
            updatePrizeListUI();
            showMessage(`Prizes updated successfully! ${state.prizes.length} available.`);
        };

        window.shufflePrizes = async () => {
            if (state.prizes.length === 0) {
                showMessage("No prizes to shuffle.");
                return;
            }
            for (let i = state.prizes.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [state.prizes[i], state.prizes[j]] = [state.prizes[j], state.prizes[i]];
            }
            await saveState();
            updatePrizeListUI();
            showMessage(`Prizes shuffled!`);
        };

        window.clearNames = async () => {
            if (confirm("Are you sure you want to clear ALL prize items?")) {
                state.prizes = [];
                await saveState();
                updatePrizeListUI();
                showMessage("All prizes cleared.");
            }
        };

        window.clearResults = async () => {
            if (confirm("Are you sure you want to clear the entire Database? please export first before clear the data to make the data safe, Please click the cancel button to cancel the data and if you already exported the data please click okay to clear the data, This cannot be undone.")) {
                state.resultsHistory = [];
                await saveState();
                renderResults();
                showMessage("Winner Database cleared.");
            }
        };

        window.updateSpinDuration = async (value) => {
            const duration = parseInt(value, 10);
            if (isNaN(duration) || duration < 1 || duration > 10) {
                showMessage("Spin duration must be between 1 and 10 seconds.", true);
                document.getElementById('spin-duration-input').value = state.spinDuration;
                return;
            }
            state.spinDuration = duration;
            await saveState();
            showMessage(`Spin duration set to ${state.spinDuration} seconds.`);
        };
        
        window.updateDepartments = async () => {
            const departmentInput = document.getElementById('department-list-input').value;
            state.departments = departmentInput.split('\n').map(d => d.trim()).filter(d => d.length > 0);
            await saveState();
            populateDepartmentDropdown();
            showMessage(`Department list updated! ${state.departments.length} departments available.`);
        }
        
        const populateDepartmentDropdown = () => {
            const dropdown = document.getElementById('modal-department');
            dropdown.innerHTML = '<option value="" disabled selected>Select Department</option>';
            state.departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                dropdown.appendChild(option);
            });
        };

        // --- Drawing and Spin Logic ---
        const COLORS = ["#FF5733", "#33FF57", "#3357FF", "#FF33F5", "#33FFF5", "#FFC300"];

        const drawWheel = (ctx, width, height) => {
            const prizes = state.prizes;
            const numSectors = prizes.length;
            const arc = 2 * Math.PI / numSectors;
            const radius = Math.min(width, height) / 2 - (width === 800 ? 20 : 12);
            
            ctx.clearRect(0, 0, width, height);
            ctx.save();
            ctx.translate(width / 2, height / 2);
            ctx.rotate(rotation);

            if (numSectors === 0) {
                ctx.fillStyle = "#ccc";
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, 2 * Math.PI);
                ctx.fill();
                ctx.fillStyle = "#333";
                ctx.font = "bold 20px Inter";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("Add Prizes in Setup Sidebar!", 0, 0);
            } else {
                for (let i = 0; i < numSectors; i++) {
                    const angle = i * arc;
                    ctx.fillStyle = COLORS[i % COLORS.length]; 

                    // Draw sector
                    ctx.beginPath();
                    ctx.arc(0, 0, radius, angle, angle + arc);
                    ctx.lineTo(0, 0);
                    ctx.fill();

                    // Draw text (prize name)
                    ctx.save();
                    ctx.rotate(angle + arc / 2);
                    ctx.fillStyle = "#fff"; // White text
                    ctx.font = `bold ${width === 800 ? '24px' : '14px'} Inter`;
                    ctx.textAlign = "right";
                    ctx.textBaseline = "middle";

                    const maxTextWidth = radius * 0.7; // Limit text to 70% of radius
                    const text = prizes[i];

                    if (ctx.measureText(text).width > maxTextWidth) {
                        let shortenedText = text;
                        while (ctx.measureText(shortenedText + '...').width > maxTextWidth && shortenedText.length > 0) {
                            shortenedText = shortenedText.substring(0, shortenedText.length - 1);
                        }
                        ctx.fillText(shortenedText + (shortenedText.length < text.length ? '...' : ''), radius * 0.95, 0);
                    } else {
                        ctx.fillText(text, radius * 0.95, 0);
                    }
                    
                    ctx.restore();
                }
            }
            ctx.restore();
        };

        const calculateRotation = (numSectors, winningIndex) => {
            const arc = 2 * Math.PI / numSectors;
            // Target angle for the center of the winning sector to align with the pointer (3 o'clock position on the canvas, -PI/2)
            // Spin multiple times (3 full rotations) + land on target
            const baseRotations = 3; 
            const targetAngle = (2 * Math.PI * baseRotations) + (Math.PI / 2) + arc * (numSectors - 1 - winningIndex);

            // Add a small random offset within the winning arc for a more natural look
            const offset = (Math.random() * arc) - (arc / 2);
            return targetAngle + offset;
        };

        window.showParticipantModal = (isFullscreenSpin) => {
             if (isSpinning || state.prizes.length === 0) {
                if (state.prizes.length === 0) {
                    showMessage("Please add prizes using the Setup sidebar first!");
                }
                return;
            }
            populateDepartmentDropdown(); // Ensure department list is current
            document.getElementById('participant-modal').dataset.isFullscreenSpin = isFullscreenSpin;
            document.getElementById('modal-fullname').value = '';
            document.getElementById('modal-department').value = ''; // Reset dropdown
            clearParticipantMessage(); // Reset modal message
            document.getElementById('participant-modal').classList.remove('hidden');
            document.getElementById('modal-fullname').focus();
        };

        window.closeParticipantModal = () => {
            document.getElementById('participant-modal').classList.add('hidden');
            document.getElementById('modal-fullname').value = '';
            document.getElementById('modal-department').value = '';
            showMessage("Click the wheel to spin and pick a prize!");
        };

        const setParticipantMessage = (message, isError) => {
            const msg = document.getElementById('participant-message');
            msg.textContent = message;
            if (isError) {
                msg.classList.remove('text-gray-600');
                msg.classList.add('text-red-500', 'font-semibold');
            } else {
                msg.classList.remove('text-red-500', 'font-semibold');
                msg.classList.add('text-gray-600');
            }
        };

        const clearParticipantMessage = () => {
            setParticipantMessage("This will be recorded in the Database.", false);
        };

        window.startSpinFromModal = () => {
            const fullname = document.getElementById('modal-fullname').value.trim();
            const department = document.getElementById('modal-department').value.trim();
            const isFullscreenSpin = document.getElementById('participant-modal').dataset.isFullscreenSpin === 'true';

            if (!fullname || !department) {
                setParticipantMessage("Please enter a full name and select a department!", true);
                return;
            }
            
            // --- START: Duplicate Name Check ---
            const normalizedName = fullname.toLowerCase();
            const isDuplicate = state.resultsHistory.some(result => 
                result.name.toLowerCase() === normalizedName
            );

            if (isDuplicate) {
                setParticipantMessage(`Error: "${fullname}" has already spun and won a prize.`, true);
                return;
            }
            // --- END: Duplicate Name Check ---


            currentSpinner = { fullname, department };
            closeParticipantModal();
            spinWheel(isFullscreenSpin);
        };

        window.toggleFullscreen = (enable) => {
            if (enable) {
                document.getElementById('fullscreen-roleta').classList.remove('hidden');
                document.getElementById('fullscreen-button').classList.add('hidden'); // Hide floaty button when fullscreen
            } else {
                document.getElementById('fullscreen-roleta').classList.add('hidden');
                document.getElementById('fullscreen-button').classList.remove('hidden'); // Show floaty button when exiting
            }
            isFullscreen = enable;
        };

        const addNewResultToHistory = (prizeWon, winningIndex, winnerName, winnerDept) => {
            const newResult = {
                id: crypto.randomUUID(),
                name: winnerName,
                prize: prizeWon,
                department: winnerDept,
                timestamp: Date.now(),
                date: new Date().toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                claimed: false, // Set to false initially, let the countdown/button set it to true
                removed: false,
                winningIndex: winningIndex
            };
            state.resultsHistory.push(newResult);
            saveState();
        };

        const spinWheel = (isFullscreenSpin) => {
            if (isSpinning || state.prizes.length === 0) return;
            isSpinning = true;

            const numSectors = state.prizes.length;
            const arc = 2 * Math.PI / numSectors;

            // Step 1: Determine the winning index (must be done before calculating rotation)
            const winningIndex = Math.floor(Math.random() * numSectors); 
            const prizeWon = state.prizes[winningIndex];
            
            // Store the winner before the prize is potentially removed later
            lastWinner = { prize: prizeWon, index: winningIndex };

            // Step 2: Calculate the rotation needed to stop on the winning index
            const finalRotation = calculateRotation(numSectors, winningIndex);
            const actualDuration = state.spinDuration * 1000;
            
            const canvasToSpin = isFullscreenSpin ? fullscreenCanvas : mainCanvas;

            // Step 3: Apply the transition and rotation
            canvasToSpin.style.transition = `transform ${actualDuration / 1000}s cubic-bezier(0.25, 0.1, 0.5, 1)`;
            canvasToSpin.style.transform = `rotate(${finalRotation}rad)`;

            showMessage(`Spinning for ${currentSpinner.fullname}...`);

            // Step 4: After the spin, determine winner, show modal, and start countdown/cleanup
            setTimeout(() => {
                isSpinning = false;
                
                // Reset transition (important for instant reset on next spin)
                canvasToSpin.style.transition = 'none'; 
                
                // Recalculate the actual stopping angle in case of small browser precision errors
                let normalizedRotation = finalRotation % (2 * Math.PI);
                if (normalizedRotation < 0) normalizedRotation += 2 * Math.PI;

                // Adjust for the canvas being drawn from the top center (PI/2 offset)
                let effectiveAngle = (2 * Math.PI) + (3 * Math.PI / 2) - normalizedRotation;
                effectiveAngle %= (2 * Math.PI);

                // This should match the pre-calculated winningIndex, but we use the prize name for safety
                // const finalWinningIndex = Math.floor(effectiveAngle / arc); 

                if (prizeWon) {
                    showMessage(`Winner: ${currentSpinner.fullname} won ${prizeWon}!`);
                    launchConfetti();
                    addNewResultToHistory(prizeWon, winningIndex, currentSpinner.fullname, currentSpinner.department);
                    showWinnerModal(prizeWon, currentSpinner.fullname, currentSpinner.department, winningIndex);
                } else {
                    showMessage("Error determining winner.");
                }
            }, actualDuration + 100);
        };

        // --- Confetti (No change) ---
        function launchConfetti() {
            const count = 200;
            const defaults = { origin: { y: 0.7 } };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, { particleCount: Math.floor(count * particleRatio) }));
            }

            fire(0.25, { spread: 26, startVelocity: 55, });
            fire(0.2, { spread: 60, });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45, });
        }

        // --- START Countdown Logic (MODIFIED) ---
        const startCountdown = () => {
            const display = document.getElementById('countdown-timer');
            const modalDisplay = document.getElementById('modal-countdown-display');
            const removeButton = document.getElementById('remove-winner-btn');
            
            // Setup display
            removeButton.classList.remove('hidden');
            display.classList.remove('hidden');
            modalDisplay.classList.remove('hidden');
            modalDisplay.classList.add('text-gray-600'); 
            modalDisplay.classList.remove('text-red-600', 'font-extrabold'); 
            
            timer = REMOVAL_DELAY_SECONDS;
            display.textContent = `Prize auto-removes in ${timer}s`;
            modalDisplay.textContent = `Prize will be removed from the wheel in ${timer} seconds...`;
            
            // Clear any existing interval
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            countdownInterval = setInterval(() => {
                timer--;
                display.textContent = `Prize auto-removes in ${timer}s`;
                modalDisplay.textContent = `Prize will be removed from the wheel in ${timer} seconds...`;
                
                if (timer <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null; 
                    
                    // Keep the modal open, but perform removal and update status
                    if (lastWinner.prize) {
                        // 1. Remove the prize from the wheel
                        removeWinnerFromWheel(lastWinner.prize, lastWinner.index, true); 
                        
                        // 2. Update UI elements to show removal status
                        removeButton.classList.add('hidden'); // Hide the "Remove Now" button since it's done
                        
                        // Update main screen message
                        display.textContent = `Prize removed: ${lastWinner.prize}. Click 'Awesome! (Close)' on modal.`;
                        
                        // Update modal message (THIS IS THE VISIBLE COUNTDOWN REMAINING ON THE MODAL)
                        modalDisplay.textContent = `Prize "${lastWinner.prize}" has been automatically removed from the wheel.`;
                        modalDisplay.classList.remove('text-gray-600'); 
                        modalDisplay.classList.add('text-red-600', 'font-extrabold'); 
                    }
                }
            }, 1000); 
        };
        // --- END Countdown Logic ---


        window.removeWinnerFromWheel = (prizeName, index, isAutoRemove) => {
            const latestHistoryEntry = state.resultsHistory.find(r => r.prize === prizeName && r.name === currentSpinner.fullname);

            if (latestHistoryEntry && !latestHistoryEntry.removed) {
                // If the entry hasn't been removed yet, check if the prize is still in the list by index
                if (index >= 0 && index < state.prizes.length && state.prizes[index] === prizeName) {
                    state.prizes.splice(index, 1);
                    latestHistoryEntry.removed = true;
                    if (!latestHistoryEntry.claimed) {
                        latestHistoryEntry.claimed = true;
                    }
                    saveState();
                    updatePrizeListUI();
                    
                    if (!isAutoRemove) {
                         // Only show message if manually triggered
                        showMessage(`Prize "${prizeName}" manually removed.`);
                    }
                    
                } else if (!isAutoRemove) { 
                    // Manual removal check: if prize is already gone but removed flag is false (shouldn't happen often)
                    latestHistoryEntry.removed = true;
                    if (!latestHistoryEntry.claimed) latestHistoryEntry.claimed = true;
                    saveState();
                    updatePrizeListUI();
                    showMessage(`Prize "${prizeName}" already removed by another action.`);
                }
            } else {
                showMessage(`Prize "${prizeName}" was already removed.`);
            }
        };

        const showWinnerModal = (prizeWon, winnerName, winnerDept, winningIndex) => {
            document.getElementById('modal-winner-name').textContent = winnerName;
            document.getElementById('modal-prize-name').textContent = prizeWon;
            document.getElementById('modal-winner-dept').textContent = `Department: ${winnerDept}`;
            document.getElementById('winner-modal').classList.remove('hidden');
            
            // Set the onclick for the manual removal button
            const removeButton = document.getElementById('remove-winner-btn');
            removeButton.onclick = () => {
                removeWinnerFromWheel(prizeWon, winningIndex, false);
                window.closeWinnerModalAndCleanUp(false);
            };

            // Start the countdown, which will now run independently
            startCountdown();
        };

        // --- CLOSE Modal Logic (MODIFIED) ---
        window.closeWinnerModalAndCleanUp = (forceClaimAndRemove) => {
            document.getElementById('winner-modal').classList.add('hidden');
            
            // Stop and hide all countdown elements on manual close, as the prize is now handled.
            clearInterval(countdownInterval);
            countdownInterval = null;
            document.getElementById('remove-winner-btn').classList.add('hidden');
            document.getElementById('countdown-timer').classList.add('hidden'); 
            document.getElementById('modal-countdown-display').classList.add('hidden');
            
            // Reset modal display styling
            document.getElementById('modal-countdown-display').classList.add('text-gray-600'); 
            document.getElementById('modal-countdown-display').classList.remove('text-red-600', 'font-extrabold'); 
            
            rotation = 0;
            mainCanvas.style.transition = 'none';
            fullscreenCanvas.style.transition = 'none';
            mainCanvas.style.transform = 'rotate(0deg)';
            fullscreenCanvas.style.transform = 'rotate(0deg)';
            drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
            drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
            mainCanvas.style.transition = 'transform 0s ease-out';
            fullscreenCanvas.style.transition = 'transform 0s ease-out';
            
            // This branch handles the "Awesome! (Close)" button click (forceClaimAndRemove = true)
            // It ensures the prize is claimed and removed if the timer hasn't finished the job yet.
            if (forceClaimAndRemove && lastWinner.prize) {
                const latestHistoryEntry = state.resultsHistory.find(r => r.prize === lastWinner.prize && r.name === currentSpinner.fullname );

                if (latestHistoryEntry && !latestHistoryEntry.claimed) {
                    latestHistoryEntry.claimed = true;

                    if (lastWinner.index >= 0 && lastWinner.index < state.prizes.length && state.prizes[lastWinner.index] === lastWinner.prize) {
                        latestHistoryEntry.removed = true;
                        state.prizes.splice(lastWinner.index, 1);
                        updatePrizeListUI();
                        showMessage(`Prize "${lastWinner.prize}" claimed and removed.`);
                    } else {
                        // Prize may have already been removed by the auto-timer just before the button was clicked
                        saveState();
                        renderResults();
                        showMessage(`Prize "${lastWinner.prize}" claimed (may have been removed already).`);
                    }
                } else if (latestHistoryEntry) {
                    showMessage(`Prize "${lastWinner.prize}" was already claimed or removed.`);
                }
            }
            lastWinner = { prize: null, index: -1 };
            currentSpinner = { fullname: null, department: null };
            showMessage("Click the wheel to spin and pick a prize!");
        };
        // --- END CLOSE Modal Logic ---


        const addNewResultToHistoryTable = (result) => {
            // New entry is added directly in addNewResultToHistory
        };

        window.filterResults = () => {
            const searchTerm = document.getElementById('history-search-input').value.toLowerCase().trim();
            renderResults(searchTerm);
        };

        const renderResults = (searchTerm = '') => {
            const resultsBody = document.getElementById('results-body');
            resultsBody.innerHTML = '';

            const sortedHistory = [...state.resultsHistory].sort((a, b) => b.timestamp - a.timestamp);
            
            const filteredHistory = sortedHistory.filter(result => 
                result.name.toLowerCase().includes(searchTerm) ||
                result.prize.toLowerCase().includes(searchTerm) ||
                result.department.toLowerCase().includes(searchTerm)
            );

            filteredHistory.forEach((result, index) => {
                const row = resultsBody.insertRow();
                
                // Find the original index for display #
                const originalIndex = state.resultsHistory.findIndex(r => r.id === result.id);
                
                let cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900';
                cell.textContent = state.resultsHistory.length - originalIndex;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500 font-bold';
                cell.textContent = result.name;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-700';
                cell.innerHTML = `${result.prize} ${result.removed ? '<span title="Removed from Wheel" class="text-red-500 ml-1">&#10003;</span>' : ''}`;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                cell.textContent = result.department;

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-500';
                cell.textContent = result.date;
                
                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-bold';
                cell.innerHTML = result.claimed ? '<span class="text-green-600">YES</span>' : '<span class="text-red-600">NO</span>'; 

                cell = row.insertCell();
                cell.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium';
                const toggleIcon = result.claimed ? `
                    <button onclick="toggleClaimed('${result.id}')" class="text-yellow-600 hover:text-yellow-900 transition p-1 rounded-md hover:bg-yellow-100 group" title="Mark as Unclaimed">
                        <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </button>` : `
                    <button onclick="toggleClaimed('${result.id}')" class="text-green-600 hover:text-green-900 transition p-1 rounded-md hover:bg-green-100 group" title="Mark as Claimed">
                        <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </button>`;
                
                cell.innerHTML = `
                    <div class="flex space-x-2">
                         <button onclick="viewResultDetails('${result.id}')" class="text-blue-600 hover:text-blue-900 transition p-1 rounded-md hover:bg-blue-100 group" title="View Details">
                            <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                        </button>
                        <button onclick="editResultDetails('${result.id}')" class="text-purple-600 hover:text-purple-900 transition p-1 rounded-md hover:bg-purple-100 group" title="Edit Record">
                             <svg class="w-5 h-5 group-hover:scale-110" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-7-7l4 4m-4-4l-9 9m9-9l9 9"></path></svg>
                        </button>
                        ${toggleIcon}
                    </div>
                `;
            });

            // Update stats display after rendering (since it depends on history)
            updateStatsDisplay();
        };

        window.viewResultDetails = (id) => {
            currentResultId = id;
            const result = state.resultsHistory.find(r => r.id === id);
            if (!result) return;
            
            document.getElementById('history-modal-title').textContent = "View Winner Details";
            document.getElementById('history-name-input').value = result.name;
            document.getElementById('history-prize-input').value = result.prize;
            document.getElementById('history-dept-input').value = result.department;
            document.getElementById('history-date-input').value = result.date;
            document.getElementById('history-claimed-status').value = result.claimed.toString();

            // Disable all inputs for viewing
            document.getElementById('history-name-input').disabled = true;
            document.getElementById('history-prize-input').disabled = true;
            document.getElementById('history-dept-input').disabled = true;
            document.getElementById('history-date-input').disabled = true;
            document.getElementById('history-claimed-status').disabled = true;
            document.getElementById('history-edit-save-btn').classList.add('hidden');
            document.getElementById('history-modal').classList.remove('hidden');
        };

        window.editResultDetails = (id) => {
            currentResultId = id;
            const result = state.resultsHistory.find(r => r.id === id);
            if (!result) return;
            
            document.getElementById('history-modal-title').textContent = "Edit Winner Record";
            document.getElementById('history-name-input').value = result.name;
            document.getElementById('history-prize-input').value = result.prize;
            document.getElementById('history-dept-input').value = result.department;
            document.getElementById('history-date-input').value = result.date;
            document.getElementById('history-claimed-status').value = result.claimed.toString();

            // Enable inputs for editing
            document.getElementById('history-name-input').disabled = false;
            document.getElementById('history-prize-input').disabled = false;
            document.getElementById('history-dept-input').disabled = false;
            document.getElementById('history-date-input').disabled = false;
            document.getElementById('history-claimed-status').disabled = false;
            document.getElementById('history-edit-save-btn').classList.remove('hidden');
            document.getElementById('history-modal').classList.remove('hidden');
        };

        window.saveHistoryEdit = async () => {
            const index = state.resultsHistory.findIndex(r => r.id === currentResultId);
            if (index === -1) return;

            const name = document.getElementById('history-name-input').value.trim();
            const prize = document.getElementById('history-prize-input').value.trim();
            const department = document.getElementById('history-dept-input').value.trim();
            const date = document.getElementById('history-date-input').value.trim();
            const claimed = document.getElementById('history-claimed-status').value === 'true';

            if (!name || !prize || !department || !date) {
                alert("All fields must be filled out.");
                return;
            }

            state.resultsHistory[index].name = name;
            state.resultsHistory[index].prize = prize;
            state.resultsHistory[index].department = department;
            state.resultsHistory[index].date = date;
            state.resultsHistory[index].claimed = claimed;

            await saveState();
            renderResults();
            closeHistoryModal();
            showMessage(`Record for ${name} updated successfully.`);
        };

        window.closeHistoryModal = () => {
            document.getElementById('history-modal').classList.add('hidden');
            currentResultId = null;
        };

        window.toggleClaimed = async (id) => {
            const index = state.resultsHistory.findIndex(r => r.id === id);
            if (index === -1) return;

            state.resultsHistory[index].claimed = !state.resultsHistory[index].claimed;
            await saveState();
            renderResults();
            showMessage(`Record for ${state.resultsHistory[index].name} marked as ${state.resultsHistory[index].claimed ? 'CLAIMED' : 'UNCLAIMED'}.`);
        };

        // --- Export Functions ---
        window.toggleExportDropdown = (button) => {
            const menu = document.getElementById('export-menu');
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            
            if (isExpanded) {
                menu.classList.add('hidden');
                button.setAttribute('aria-expanded', 'false');
            } else {
                menu.classList.remove('hidden');
                button.setAttribute('aria-expanded', 'true');
            }
        };

        window.exportAsJson = () => {
            const data = {
                prizes: state.prizes,
                resultsHistory: state.resultsHistory,
                config: { spinDuration: state.spinDuration },
                departments: state.departments
            };

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raffle_data_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('export-menu').classList.add('hidden');
            document.getElementById('export-menu-button').setAttribute('aria-expanded', 'false');
            showMessage("All data exported successfully as JSON.");
        };

        // NEW: Function to export as Excel (CSV format for simplicity)
        window.exportAsExcel = () => {
            // Collect data from resultsHistory
            const results = state.resultsHistory.map(r => ({
                ID: r.id,
                Name: r.name,
                Prize: r.prize,
                Department: r.department,
                Date: r.date,
                Claimed: r.claimed ? 'Yes' : 'No',
                Removed_from_Wheel: r.removed ? 'Yes' : 'No'
            }));

            if (results.length === 0) {
                showMessage("No data to export to Excel.");
                document.getElementById('export-menu').classList.add('hidden');
                document.getElementById('export-menu-button').setAttribute('aria-expanded', 'false');
                return;
            }

            // Convert array of objects to CSV string
            const headers = Object.keys(results[0]);
            const csvContent = [
                headers.join(','), // Header row
                ...results.map(row => headers.map(header => JSON.stringify(row[header])).join(',')) // Data rows
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raffle_data_export_${new Date().toISOString().slice(0, 10)}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            document.getElementById('export-menu').classList.add('hidden');
            document.getElementById('export-menu-button').setAttribute('aria-expanded', 'false');
            showMessage("All data exported successfully as Excel (CSV).");
        };

        // NEW: Function to export as PDF (using browser's print function for simplicity)
        window.exportAsPdf = () => {
            // Temporarily switch to results tab and trigger print
            showTab('results'); 
            
            // Wait for a moment to ensure the tab is fully rendered before printing
            setTimeout(() => {
                window.print();
                
                document.getElementById('export-menu').classList.add('hidden');
                document.getElementById('export-menu-button').setAttribute('aria-expanded', 'false');
                showMessage("Print dialogue opened for PDF export.");
            }, 100); 
        };
        
        // Export Prizes from Sidebar
        window.exportPrizes = () => {
             const data = {
                prizes: state.prizes
            };

            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `raffle_prizes_export_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage("Prize list exported successfully as JSON.");
        }


        // --- Import Functions ---
        window.importPrizesFromSidebar = (event) => {
             const file = event.target.files[0];
             if (!file) {
                 event.target.value = null;
                 return;
             }

             const reader = new FileReader();
             reader.onload = async (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.prizes || !Array.isArray(importedData.prizes)) {
                        throw new Error("Invalid file structure. Missing or incorrect 'prizes' array.");
                    }
                    
                    state.prizes = importedData.prizes.map(p => p.toString().trim()).filter(p => p.length > 0);
                    await saveState();
                    updateSettingsUI();
                    updatePrizeListUI();
                    showMessage(`Successfully imported ${state.prizes.length} prize items!`);
                } catch (error) {
                    showMessage("Failed to import prize data: " + error.message);
                    console.error("Prize Import Error:", error);
                } finally {
                    event.target.value = null;
                }
             };
             reader.readAsText(file);
        };
        
        window.importData = (event) => {
            const file = event.target.files[0];
            if (!file) {
                event.target.value = null;
                return;
            }
            if (!confirm("WARNING: Are you sure you want to replace ALL current data (Prizes, History, Config, Departments) with the imported file content? This cannot be undone.")) {
                event.target.value = null;
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async (e) => {
                let importedData;
                try {
                    importedData = JSON.parse(e.target.result);

                    // --- 1. Basic Structure Validation ---
                    if (!importedData.prizes || !Array.isArray(importedData.prizes)) {
                        throw new Error("Invalid file structure. Missing or incorrect 'prizes' array.");
                    }
                    if (!importedData.resultsHistory || !Array.isArray(importedData.resultsHistory)) {
                        throw new Error("Invalid file structure. Missing or incorrect 'resultsHistory' array.");
                    }
                    if (!importedData.config || typeof importedData.config.spinDuration === 'undefined') {
                        throw new Error("Invalid file structure. Missing or incorrect 'config' field.");
                    }
                    if (importedData.departments && !Array.isArray(importedData.departments)) {
                         throw new Error("Invalid file structure. 'departments' field found but is not an array.");
                    }


                    // --- 2. Data Sanitization and Loading ---
                    const newPrizes = importedData.prizes.map(p => p.toString().trim()).filter(p => p.length > 0);
                    const newResultsHistory = importedData.resultsHistory.map(r => {
                        // Ensure all history entries have the required fields
                        return {
                            id: r.id || crypto.randomUUID(),
                            name: r.name ? r.name.toString() : 'Unknown',
                            prize: r.prize ? r.prize.toString() : 'Unknown Prize',
                            department: r.department ? r.department.toString() : 'N/A',
                            timestamp: r.timestamp || Date.now(),
                            date: r.date || new Date().toLocaleDateString(undefined, { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }),
                            claimed: typeof r.claimed === 'boolean' ? r.claimed : true,
                            removed: typeof r.removed === 'boolean' ? r.removed : (typeof r.claimed === 'boolean' ? r.claimed : true),
                            winningIndex: r.winningIndex
                        };
                    });
                    const newDepartments = (importedData.departments || []).map(d => d.toString().trim()).filter(d => d.length > 0);
                    
                    state.prizes = newPrizes;
                    state.resultsHistory = newResultsHistory;
                    state.spinDuration = parseInt(importedData.config.spinDuration) || 3;
                    if (newDepartments.length > 0) {
                         state.departments = newDepartments;
                    }
                    
                    await saveState(); // Save the new, complete state
                    updateSettingsUI();
                    updatePrizeListUI();
                    renderResults();

                    showMessage(`Successfully imported all data! ${newPrizes.length} prizes and ${newResultsHistory.length} records loaded.`);
                } catch (error) {
                    showMessage("Failed to import data: " + error.message);
                    console.error("Data Import Error:", error);
                } finally {
                    event.target.value = null;
                }
            };
            reader.readAsText(file);
        };

        // --- Initialization ---
        window.addEventListener('load', async () => {
            await loadState();
            updateSettingsUI();
            drawWheel(mainCtx, mainCanvas.width, mainCanvas.height);
            drawWheel(fullscreenCtx, fullscreenCanvas.width, fullscreenCanvas.height);
            renderResults(); // Initial render of results tab

            // Event Listeners for spinning
            mainCanvas.addEventListener('click', () => showParticipantModal(false));
            fullscreenCanvas.addEventListener('click', () => showParticipantModal(true));
        });

    </script>
<script>
        function protectSourceCode() {
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
            });

            document.addEventListener('keydown', function(e) {
                if (e.keyCode === 123 || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
                    (e.ctrlKey && e.keyCode === 85) || 
                    (e.ctrlKey && e.shiftKey && e.keyCode === 67) || 
                    (e.ctrlKey && e.keyCode === 83) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                    (e.ctrlKey && e.shiftKey && e.keyCode === 74)) {
                    e.preventDefault();
                    return false;
                }
            });

            document.addEventListener('selectstart', function(e) {
                e.preventDefault();
            });

            document.addEventListener('dragstart', function(e) {
                e.preventDefault();
            });

            document.onselectstart = function() {
                return false;
            };

            document.oncontextmenu = function() {
                return false;
            };
        }

        window.addEventListener('load', protectSourceCode);
    </script>
</body>
</html>
